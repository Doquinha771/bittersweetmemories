<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS2 Style Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --ps2-blue: #0033cc;
            --ps2-dark-blue: #001a66;
            --ps2-text: #e0e0e0;
            --album-theme-color: var(--ps2-blue);
        }

        body {
            font-family: 'VT323', monospace;
            background-color: #0d0d0d;
            color: var(--ps2-text);
            overflow: hidden;
        }

        /* Efeitos CRT (TV antiga) */
        .crt-effect::before {
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 100;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            animation: flicker 0.15s infinite;
        }

        .crt-effect::after {
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: rgba(18, 16, 16, 0.1);
            opacity: 0;
            z-index: 100;
            pointer-events: none;
            animation: scanline 10s linear infinite;
        }

        @keyframes flicker {
            0% { opacity: 0.2; } 20% { opacity: 0.8; } 40% { opacity: 0.3; }
            60% { opacity: 1; } 80% { opacity: 0.4; } 100% { opacity: 1; }
        }

        @keyframes scanline {
            0% { transform: translateY(0%); } 100% { transform: translateY(100%); }
        }

        .screen-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.5s ease-in-out, filter 0.5s ease-in-out;
            filter: blur(0);
        }

        .screen-hidden {
            opacity: 0;
            pointer-events: none;
            filter: blur(5px);
        }
        
        /* Tela de Seleção de CD */
        #selection-screen {
            perspective: 1500px;
            background: radial-gradient(circle, var(--album-theme-color) 0%, #0d0d0d 70%);
            transition: background 0.5s ease;
        }

        .cd-selection-item {
            transform-style: preserve-3d;
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
        }

        .cd-selection-item:hover {
            transform: rotateY(-30deg) scale(1.05);
        }

        .cd-case {
            width: 200px; height: 200px; position: relative;
            transform-style: preserve-3d; transform: rotateY(0deg);
        }

        .cd-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; background-color: #1a1a1a; border: 1px solid #333;
        }

        .cd-front-cover {
            transform: translateZ(10px); background-size: cover; background-position: center;
        }

        .cd-spine {
            width: 20px; height: 200px; left: 90px; background-color: #111;
            transform: rotateY(90deg) translateZ(-110px);
            display: flex; align-items: center; justify-content: center;
        }
        
        .cd-spine-text {
            writing-mode: vertical-rl; text-orientation: mixed;
            transform: rotate(180deg); white-space: nowrap; font-size: 14px;
        }

        /* Player Screen */
        .cd-2d {
            width: 150px; height: 150px; border-radius: 50%;
            background-size: cover; background-position: center;
            box-shadow: 0 0 20px 5px rgba(255, 255, 255, 0.2);
            transition: transform 1s linear;
        }

        .cd-2d.playing { animation: spin 4s linear infinite; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        #track-name-container { width: 250px; overflow: hidden; position: relative; }

        #track-name {
            display: inline-block; white-space: nowrap; position: absolute;
            left: 50%; transform: translateX(-50%);
        }

        .scrolling { animation: scroll-text 10s linear infinite; }

        @keyframes scroll-text {
            0%   { transform: translateX(100%); } 100% { transform: translateX(-100%); }
        }
        
        #progress-bar-container { display: flex; gap: 2px; cursor: pointer; }

        .progress-block {
            flex-grow: 1; height: 12px; background-color: #333; transition: background-color 0.2s;
        }

        .progress-block.filled { background-color: var(--ps2-text); }
        
        .player-btn {
            background-color: transparent; border: 1px solid var(--ps2-text);
            padding: 5px; transition: background-color 0.2s, color 0.2s;
        }
        .player-btn:hover { background-color: var(--ps2-text); color: #0d0d0d; }
        .player-btn.active {
            background-color: var(--album-theme-color); border-color: var(--album-theme-color); color: #fff;
        }

        /* Transição do CD */
        #cd-transition-element {
            position: fixed; z-index: 200; background-size: cover; background-position: center;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 0;
        }
        
        /* Soundscape / Fullscreen */
        #soundscape-mode, #fullscreen-video-mode { background-size: cover; background-position: center; }
        
        #soundscape-mode::before, #fullscreen-video-mode::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5); backdrop-filter: blur(20px);
        }

        #video-background-overlay.blue-tint {
            background-color: rgba(0, 51, 204, 0.4) !important; /* PS2 blue com opacidade */
        }

        /* Screensaver DVD */
        #dvd-screensaver {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #000; z-index: 300;
        }
        #dvd-logo {
            position: absolute; width: 150px; height: auto; font-size: 5rem;
            font-weight: bold; color: white; text-shadow: 2px 2px 4px #000;
        }
        
        /* Tracklist Modal */
        #tracklist-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 250;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #tracklist-content {
            background-color: #0d0d0d;
            border: 2px solid var(--ps2-text);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        #tracklist-header {
            padding: 1rem;
            border-bottom: 2px solid var(--ps2-text);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #tracklist-list {
            padding: 1rem;
            overflow-y: auto;
        }
        .tracklist-item {
            padding: 0.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            border-bottom: 1px solid #333;
        }
        .tracklist-item:hover {
            background-color: var(--album-theme-color);
            color: #fff;
        }
        .tracklist-item.playing {
            background-color: var(--album-theme-color);
            color: #fff;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-black text-white crt-effect">

    <!-- Tela de Seleção de Discos -->
    <div id="selection-screen" class="screen-container flex flex-col items-center justify-center p-8">
        <h1 class="text-6xl mb-12 tracking-widest">Select Disc</h1>
        <div id="cd-selection-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-16">
            <!-- CDs serão inseridos aqui via JS -->
        </div>
    </div>

    <!-- Tela do Player -->
    <div id="player-screen" class="screen-container screen-hidden flex flex-col items-center justify-between p-4 h-full">
        <!-- Vídeo de fundo -->
        <div id="video-background-container" class="absolute top-0 left-0 w-full h-full -z-10 opacity-30 overflow-hidden">
             <div id="video-background-player"></div>
             <div id="video-background-overlay" class="absolute top-0 left-0 w-full h-full"></div>
        </div>

        <div class="w-full flex justify-between items-start text-2xl">
            <button id="back-btn" class="player-btn">← Back</button>
            <div id="clock" class="pr-2">12:00:00</div>
        </div>

        <div class="flex flex-col items-center gap-4">
            <div id="player-cd" class="cd-2d"></div>
            <div id="track-number" class="text-2xl">TRACK 01</div>
            <div id="track-name-container" class="h-8 text-3xl text-center"><span id="track-name">Track Name</span></div>
            <div id="visualizer" class="w-80 h-16 flex items-end justify-center gap-1">
                <!-- Barras do visualizador serão inseridas aqui via JS -->
            </div>
        </div>

        <div class="w-full max-w-2xl flex flex-col items-center gap-3">
            <div class="w-full flex justify-between text-2xl">
                <div id="time-display">0:00 / 0:00</div>
            </div>
            <div id="progress-bar-container" class="w-full h-3 rounded-full"></div>
            <div class="flex items-center gap-4 text-3xl mt-2">
                <button id="rewind-btn" class="player-btn">«5s</button>
                <button id="prev-btn" class="player-btn">«</button>
                <button id="play-btn" class="player-btn">▶</button>
                <button id="pause-btn" class="player-btn hidden">❚❚</button>
                <button id="next-btn" class="player-btn">»</button>
                <button id="forward-btn" class="player-btn">5s»</button>
            </div>
             <div class="flex items-center gap-4 text-xl mt-2">
                <button id="shuffle-btn" class="player-btn">Shuffle</button>
                <button id="repeat-btn" class="player-btn">Repeat</button>
                <button id="viz-btn" class="player-btn active">Visualizer</button>
                <button id="soundscape-btn" class="player-btn">Soundscape</button>
                <button id="tracklist-btn" class="player-btn">Tracklist</button>
            </div>
             <div class="flex items-center gap-2 text-xl">
                <span>Volume</span>
                <input id="volume-slider" type="range" min="0" max="100" value="100" class="w-32">
            </div>
        </div>
    </div>

    <!-- Modal da Tracklist -->
    <div id="tracklist-modal" class="screen-hidden">
        <div id="tracklist-content">
            <div id="tracklist-header">
                <h2 id="tracklist-album-title" class="text-3xl">Tracklist</h2>
                <button id="close-tracklist-btn" class="player-btn text-2xl">X</button>
            </div>
            <div id="tracklist-list">
                <!-- Itens da tracklist serão inseridos aqui via JS -->
            </div>
        </div>
    </div>

    <!-- Modo Soundscape -->
    <div id="soundscape-mode" class="screen-container screen-hidden flex flex-col items-center justify-center text-white">
        <div class="relative z-10 flex flex-col items-center justify-center text-center">
            <div id="soundscape-cd" class="cd-2d playing" style="width: 300px; height: 300px;"></div>
            <h2 id="soundscape-track-name" class="text-5xl mt-8">Track Name</h2>
            <p id="soundscape-time" class="text-3xl mt-4">0:00 / 0:00</p>
            <button id="exit-soundscape-btn" class="player-btn mt-8 text-2xl">Exit</button>
        </div>
    </div>

    <!-- Modo Vídeo Fullscreen -->
    <div id="fullscreen-video-mode" class="screen-container screen-hidden flex flex-col items-center justify-center">
         <div id="fullscreen-video-player" class="absolute top-0 left-0 w-full h-full z-0"></div>
         <button id="exit-fullscreen-btn" class="player-btn absolute bottom-5 z-10 text-2xl">Exit Fullscreen</button>
    </div>
    
    <!-- Protetor de Tela DVD -->
    <div id="dvd-screensaver" class="screen-hidden">
        <div id="dvd-logo">DVD</div>
    </div>

    <!-- Elemento de transição -->
    <div id="cd-transition-element"></div>
    
    <!-- Player do YouTube (invisível) -->
    <div id="youtube-player" class="absolute -top-full -left-full"></div>

    <script>
        const albums = [
            {
                title: "Validation",
                cover: "https://i1.sndcdn.com/artworks-zMJy5oUhjfM05LnK-AzuGwA-t500x500.jpg",
                theme: { primary: '#4CAF50', secondary: '#0033cc' }, // Verde e Azul
                videoTint: 'blue',
                tracks: [
                    { title: "Sucesso FM", audioId: 'tkl_smLRtcE', musicVideoId: 'tqdOIs3K-SA', videoLoop: true },
                    { title: "Rumo a Vitória", audioId: 'gTsZ-vQLq74' },
                    { title: "Goddamn", audioId: 'fGhkeEmMDSU' },
                    { title: "I Walk", audioId: 'pKyoxG2ZDh8', musicVideoId: 'lvABzBQDYGY', videoLoop: true },
                    { title: "Waiting to Fly", audioId: '-1WfKz06Hgc', musicVideoId: 'hX2NJxJP6Mc', videoLoop: true },
                    { title: "Sonhar", audioId: 'llJZ4H4zQ2k', musicVideoId: 'WCtvzfzKStU', videoStart: 39, videoLoop: true },
                    { title: "I'm in Love", audioId: 'TQ2OtyCtOMc' },
                    { title: "For my Family", audioId: 'u3M_KURTWKY', musicVideoId: 'krU-M8WusuY', videoLoop: true },
                    { title: "Going Home", audioId: 'm8SzrWpCjKU' },
                    { title: "The Lord and Me", audioId: 'rfIV2uGZ2kM' },
                    { title: "Anjos da Guarda", audioId: 'ozu12D-DdJk', musicVideoId: 'gI_2-LacLiI', videoLoop: true },
                    { title: "We Gold", audioId: 'HjA6fwTInT0' },
                ]
            },
            {
                title: "Bittersweet Memories",
                cover: "https://i.scdn.co/image/ab67616d0000b2732e8e4cfa666ea534d070c041",
                theme: { primary: '#f59e0b', secondary: '#fbbf24' }, // Laranja Dourado e Amarelo
                tracks: [
                    { title: "Saúde", audioId: 'xXeDMfisrU8' }, { title: "Filho Pródigo", audioId: 'rsxeE1WkHqw' },
                    { title: "Let It Pour", audioId: 'KzUUemEW_iI' }, { title: "The Story", audioId: 'qkaxqSGI_OE' },
                    { title: "Back Home", audioId: 'fnRyVCxqLqk' }, { title: "Melhor Não", audioId: 'RMeJND0yzeM' },
                    { title: "Old School", audioId: 'yApMEdYtkGM' }, { title: "Dirty Dancing", audioId: 'ZBe3GmoFJys' },
                    { title: "Prefiro Morrer", audioId: 'g0_DLkqjylU' }, { title: "Quase Perfeito", audioId: 'vLQR5UCq5J0' },
                    { title: "Máquina do Tempo", audioId: 'Z7LsJA7NJF0' }, { title: "Flores de Outro Carnaval", audioId: 'tR-m63k2nNM' },
                ]
            },
            {
                title: "13 Lentes de um Final Feliz",
                cover: "https://cdn-images.dzcdn.net/images/cover/a01cc5f5bbb09711637d4927e9ab83cd/500x500.jpg",
                theme: { primary: '#e5e7eb', secondary: '#9ca3af' }, // Branco e Cinza
                tracks: [
                    { title: "Au revoir", audioId: 'dQw4w9WgXcQ' }, { title: "Carruagem", audioId: 'dQw4w9WgXcQ' },
                    { title: "Agradeço", audioId: 'dQw4w9WgXcQ' }, { title: "Corrida", audioId: 'dQw4w9WgXcQ' },
                    { title: "Joias da Família", audioId: 'dQw4w9WgXcQ' },
                    { title: "Nunca Paro", audioId: 'TSLRScqwemI', musicVideoId: 'P9NqaluDZuk', videoLoop: true },
                    { title: "Memórias", audioId: 'dQw4w9WgXcQ' }, { title: "Lost in Translation", audioId: 'dQw4w9WgXcQ' },
                    { title: "Primavera", audioId: 'dQw4w9WgXcQ' }, { title: "Let me see the sun", audioId: 'dQw4w9WgXcQ' },
                    { title: "Adeus", audioId: 'dQw4w9WgXcQ' }, { title: "Deixa Doer", audioId: 'dQw4w9WgXcQ' },
                    { title: "Não me faça falar", audioId: 'dQw4w9WgXcQ' },
                ]
            },
            {
                title: "Óptica",
                cover: "https://images.genius.com/a1c5e0cebf8fdb9629ff8205d02af9ff.1000x1000x1.png",
                theme: { primary: '#a0c4ff', secondary: '#ffffff' }, // Azul Bebê e Branco
                tracks: [
                    { title: "Absorver", audioId: 'dQw4w9WgXcQ' }, { title: "Reflexo", audioId: 'dQw4w9WgXcQ' },
                    { title: "Sombra", audioId: 'ENmHHlGVAtE', musicVideoId: '1EYOFvZmnJE', videoLoop: true },
                    { title: "Transparência", audioId: 'dQw4w9WgXcQ' },
                ]
            },
            {
                title: "Bons Tempos",
                cover: "https://akamai.sscdn.co/uploadfile/letras/albuns/3/0/9/c/2338071724245865.jpg",
                theme: { primary: '#a78bfa', secondary: '#fefce8' }, // Roxo e Cor da Lua (Marfim)
                tracks: [
                    { title: "Quando a noite vem", audioId: 'XUYNTXXhmbc' },
                    { title: "Oxford Shoes", audioId: 'wwVejlwrKTA' },
                    { title: "Twist", audioId: 'R3BWRueflA4', musicVideoId: 'hcL33v1N8uQ', videoLoop: true },
                    { title: "American Dream", audioId: '61o4MC3kEsM' },
                    { title: "A Cidade sem você", audioId: 'MUqryi1MIrs' },
                    { title: "Um certo alguem", audioId: 'amC0UxaMz9Y' },
                    { title: "Playback", audioId: 'slgXDu2Ck2A' },
                    { title: "Amiga fiel", audioId: 'wVmcDQ_yX5g' },
                    { title: "Televisão", audioId: 'yqRAcdaqLNI' },
                    { title: "Raise my hands", audioId: 'y1v-bI4_k2I' },
                ]
            }
        ];

        // Elementos da DOM
        const selectionScreen = document.getElementById('selection-screen');
        const playerScreen = document.getElementById('player-screen');
        const cdSelectionGrid = document.getElementById('cd-selection-grid');
        const backBtn = document.getElementById('back-btn');
        const playerCd = document.getElementById('player-cd');
        const trackNumberEl = document.getElementById('track-number');
        const trackNameEl = document.getElementById('track-name');
        const trackNameContainer = document.getElementById('track-name-container');
        const timeDisplayEl = document.getElementById('time-display');
        const progressBar = document.getElementById('progress-bar-container');
        const playBtn = document.getElementById('play-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const stopBtn = document.getElementById('stop-btn');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const rewindBtn = document.getElementById('rewind-btn');
        const forwardBtn = document.getElementById('forward-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const vizBtn = document.getElementById('viz-btn');
        const soundscapeBtn = document.getElementById('soundscape-btn');
        const tracklistBtn = document.getElementById('tracklist-btn');
        const volumeSlider = document.getElementById('volume-slider');
        const clockEl = document.getElementById('clock');
        const visualizerEl = document.getElementById('visualizer');
        
        // Modal
        const tracklistModal = document.getElementById('tracklist-modal');
        const tracklistAlbumTitle = document.getElementById('tracklist-album-title');
        const tracklistList = document.getElementById('tracklist-list');
        const closeTracklistBtn = document.getElementById('close-tracklist-btn');
        
        // Modos
        const soundscapeMode = document.getElementById('soundscape-mode');
        const exitSoundscapeBtn = document.getElementById('exit-soundscape-btn');
        const fullscreenVideoMode = document.getElementById('fullscreen-video-mode');
        const exitFullscreenBtn = document.getElementById('exit-fullscreen-btn');
        const soundscapeCd = document.getElementById('soundscape-cd');
        const soundscapeTrackName = document.getElementById('soundscape-track-name');
        const soundscapeTime = document.getElementById('soundscape-time');

        // Screensaver
        const dvdScreensaver = document.getElementById('dvd-screensaver');
        const dvdLogo = document.getElementById('dvd-logo');
        
        // Vídeo
        const videoBgContainer = document.getElementById('video-background-container');
        const videoBgOverlay = document.getElementById('video-background-overlay');

        // Estado do Player
        let player, videoBgPlayer, fullscreenVideoPlayer;
        let currentAlbumIndex = 0, currentTrackIndex = 0;
        let playlist = [], isPlaying = false, isShuffle = false;
        let repeatMode = 'none', progressInterval, inactivityTimer;
        
        // Inicialização do YouTube IFrame API
        function onYouTubeIframeAPIReady() {
            // Player de Áudio Principal
            player = new YT.Player('youtube-player', {
                height: '0', width: '0',
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
            
            // Player de Vídeo de Fundo
            videoBgPlayer = new YT.Player('video-background-player', {
                height: '100%', width: '100%',
                playerVars: { 'autoplay': 1, 'controls': 0, 'showinfo': 0, 'rel': 0, 'mute': 1, 'playsinline': 1 },
                events: { 'onReady': (event) => event.target.mute(), 'onStateChange': onVideoStateChange }
            });

            // Player de Vídeo em Tela Cheia
            fullscreenVideoPlayer = new YT.Player('fullscreen-video-player', {
                height: '100%', width: '100%',
                playerVars: { 'autoplay': 0, 'controls': 0, 'showinfo': 0, 'rel': 0, 'mute': 1, 'playsinline': 1 },
                 events: { 'onReady': (event) => event.target.mute(), 'onStateChange': onVideoStateChange }
            });
        }

        function onPlayerReady(event) {
            // A configuração dos listeners foi movida para window.onload
        }

        // Gerencia o estado do player de áudio
        function onPlayerStateChange(event) {
            resetInactivityTimer();
            const state = event.data;
            
            if (state === YT.PlayerState.PLAYING) {
                startProgressInterval(); isPlaying = true; updatePlayPauseButtons(); playerCd.classList.add('playing');
                if(videoBgPlayer && typeof videoBgPlayer.playVideo === 'function') videoBgPlayer.playVideo();
                if(fullscreenVideoPlayer.isMuted() && typeof fullscreenVideoPlayer.playVideo === 'function') fullscreenVideoPlayer.playVideo();
            } else {
                stopProgressInterval(); isPlaying = false; updatePlayPauseButtons(); playerCd.classList.remove('playing');
                if (state === YT.PlayerState.PAUSED) {
                    if(videoBgPlayer && typeof videoBgPlayer.pauseVideo === 'function') videoBgPlayer.pauseVideo();
                    if(fullscreenVideoPlayer && typeof fullscreenVideoPlayer.pauseVideo === 'function') fullscreenVideoPlayer.pauseVideo();
                }
            }
            if (state === YT.PlayerState.ENDED) { handleTrackEnd(); }
        }

        // BUG FIX: Gerencia o estado dos players de vídeo para garantir o loop
        function onVideoStateChange(event) {
            const track = albums[currentAlbumIndex].tracks[playlist[currentTrackIndex]];
            // Se o vídeo terminar e tiver a flag de loop, reinicia ele.
            if (event.data === YT.PlayerState.ENDED && track.videoLoop) {
                event.target.seekTo(track.videoStart || 0);
                event.target.playVideo();
            }
        }
        
        function handleTrackEnd() {
            if (repeatMode === 'one') { playTrack(currentTrackIndex); } else { playNext(); }
        }

        // Funções do Player
        function loadAlbum(albumIndex) {
            currentAlbumIndex = albumIndex;
            const album = albums[albumIndex];
            playlist = Array.from(Array(album.tracks.length).keys());
            if(isShuffle) { shufflePlaylist(); }
            loadTrack(0);
            updatePlayerUIForAlbum(album);
            showScreen(playerScreen);
        }

        function loadTrack(playlistIndex) {
            if (playlistIndex < 0 || playlistIndex >= playlist.length) {
                 if (repeatMode === 'all') { currentTrackIndex = 0; } else { stopPlayback(); return; }
            } else { currentTrackIndex = playlistIndex; }

            const trackIndexInAlbum = playlist[currentTrackIndex];
            const track = albums[currentAlbumIndex].tracks[trackIndexInAlbum];
            
            player.loadVideoById({ videoId: track.audioId, startSeconds: track.startSeconds || 0 });
            updateTrackInfo(track, trackIndexInAlbum);
            
            // BUG FIX: Garante que o player de vídeo exista antes de usá-lo
            if (track.musicVideoId && videoBgPlayer && typeof videoBgPlayer.loadVideoById === 'function') {
                const videoOptions = { videoId: track.musicVideoId, startSeconds: track.videoStart || 0 };
                videoBgPlayer.loadVideoById(videoOptions);
                videoBgContainer.style.opacity = '0.3';
                soundscapeBtn.textContent = "Fullscreen";
            } else {
                if(videoBgPlayer && typeof videoBgPlayer.stopVideo === 'function') videoBgPlayer.stopVideo();
                videoBgContainer.style.opacity = '0';
                soundscapeBtn.textContent = "Soundscape";
            }
        }
        
        function playTrack(playlistIndex) { loadTrack(playlistIndex); }

        function playNext() {
            let nextIndex = currentTrackIndex + 1;
            if (nextIndex >= playlist.length) {
                if (repeatMode === 'all') { nextIndex = 0; } else { stopPlayback(); return; }
            }
            playTrack(nextIndex);
        }

        function playPrev() {
            let prevIndex = currentTrackIndex - 1;
            if (prevIndex < 0) { prevIndex = playlist.length - 1; }
            playTrack(prevIndex);
        }
        
        function stopPlayback() {
            if(player && typeof player.stopVideo === 'function') player.stopVideo();
            if(videoBgPlayer && typeof videoBgPlayer.stopVideo === 'function') videoBgPlayer.stopVideo();
            if(fullscreenVideoPlayer && typeof fullscreenVideoPlayer.stopVideo === 'function') fullscreenVideoPlayer.stopVideo();
            stopProgressInterval(); resetProgressBar();
            isPlaying = false; updatePlayPauseButtons(); playerCd.classList.remove('playing');
        }

        function seekRelative(seconds) {
            const currentTime = player.getCurrentTime();
            const newTime = currentTime + seconds;
            player.seekTo(newTime, true);
            // Sincroniza os players de vídeo se existirem
            if(videoBgPlayer && typeof videoBgPlayer.seekTo === 'function') videoBgPlayer.seekTo(newTime, true);
            if(fullscreenVideoPlayer && typeof fullscreenVideoPlayer.seekTo === 'function') fullscreenVideoPlayer.seekTo(newTime, true);
        }
        
        function toggleShuffle() {
            isShuffle = !isShuffle;
            shuffleBtn.classList.toggle('active', isShuffle);
            const currentTrackRealIndex = playlist[currentTrackIndex];
            if (isShuffle) { shufflePlaylist(); } 
            else { playlist = Array.from(Array(albums[currentAlbumIndex].tracks.length).keys()); }
            currentTrackIndex = playlist.findIndex(i => i === currentTrackRealIndex);
        }
        
        function shufflePlaylist() {
            for (let i = playlist.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [playlist[i], playlist[j]] = [playlist[j], playlist[i]];
            }
        }
        
        function toggleRepeat() {
            if(repeatMode === 'none') { repeatMode = 'all'; repeatBtn.textContent = 'Repeat All'; repeatBtn.classList.add('active'); } 
            else if (repeatMode === 'all') { repeatMode = 'one'; repeatBtn.textContent = 'Repeat One'; } 
            else { repeatMode = 'none'; repeatBtn.textContent = 'Repeat'; repeatBtn.classList.remove('active'); }
        }

        // Funções de UI
        function initializeCDSelection() {
            cdSelectionGrid.innerHTML = '';
            albums.forEach((album, index) => {
                const item = document.createElement('div');
                item.className = 'cd-selection-item';
                item.innerHTML = `<div class="cd-case"><div class="cd-face cd-front-cover" style="background-image: url('${album.cover}')"></div><div class="cd-face cd-spine"><span class="cd-spine-text">${album.title}</span></div></div>`;
                item.addEventListener('mouseenter', () => document.documentElement.style.setProperty('--album-theme-color', album.theme.primary));
                item.addEventListener('click', () => handleCDSelection(item, index));
                cdSelectionGrid.appendChild(item);
            });
        }
        
        function handleCDSelection(element, albumIndex) {
            const startRect = element.getBoundingClientRect();
            const targetRect = playerCd.getBoundingClientRect();
            const transitionEl = document.getElementById('cd-transition-element');
            transitionEl.style.backgroundImage = `url('${albums[albumIndex].cover}')`;
            Object.assign(transitionEl.style, { left: `${startRect.left}px`, top: `${startRect.top}px`, width: `${startRect.width}px`, height: `${startRect.height}px`, borderRadius: '0', transform: 'rotateY(0deg) rotate(0deg)' });
            selectionScreen.classList.add('screen-hidden');
            setTimeout(() => Object.assign(transitionEl.style, { left: `${targetRect.left}px`, top: `${targetRect.top}px`, width: `${targetRect.width}px`, height: `${targetRect.height}px`, borderRadius: '50%', transform: 'rotate(720deg)' }), 50);
            setTimeout(() => { transitionEl.style.backgroundImage = ''; loadAlbum(albumIndex); }, 850);
        }

        function showScreen(screen) {
            document.querySelectorAll('.screen-container').forEach(s => s.classList.add('screen-hidden'));
            screen.classList.remove('screen-hidden');
        }
        
        function updatePlayerUIForAlbum(album) {
            document.documentElement.style.setProperty('--album-theme-color', album.theme.primary);
            playerCd.style.backgroundImage = `url('${album.cover}')`;
            soundscapeCd.style.backgroundImage = `url('${album.cover}')`;
            soundscapeMode.style.backgroundImage = `url('${album.cover}')`;
            videoBgOverlay.classList.toggle('blue-tint', album.videoTint === 'blue');
            if (album.videoTint !== 'blue') {
                videoBgOverlay.style.backgroundColor = `${album.theme.secondary}66`; // 40% opacity
            } else {
                videoBgOverlay.style.backgroundColor = '';
            }
        }

        function updateTrackInfo(track, trackIndexInAlbum) {
            trackNumberEl.textContent = `TRACK ${String(trackIndexInAlbum + 1).padStart(2, '0')}`;
            trackNameEl.textContent = track.title;
            soundscapeTrackName.textContent = track.title;
            setTimeout(() => trackNameEl.classList.toggle('scrolling', trackNameEl.scrollWidth > trackNameContainer.offsetWidth), 100);
        }

        function updatePlayPauseButtons() {
            playBtn.classList.toggle('hidden', isPlaying);
            pauseBtn.classList.toggle('hidden', !isPlaying);
        }
        
        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${String(sec).padStart(2, '0')}`;
        }
        
        function startProgressInterval() {
            stopProgressInterval();
            progressInterval = setInterval(() => {
                const currentTime = player.getCurrentTime() || 0;
                const duration = player.getDuration() || 0;
                const timeText = `${formatTime(currentTime)} / ${formatTime(duration)}`;
                timeDisplayEl.textContent = timeText;
                soundscapeTime.textContent = timeText;
                updateProgressBar(duration > 0 ? (currentTime / duration) : 0);
            }, 500);
        }
        
        function stopProgressInterval() { clearInterval(progressInterval); }
        function resetProgressBar() { updateProgressBar(0); timeDisplayEl.textContent = `0:00 / 0:00`; }

        function createProgressBar() {
            progressBar.innerHTML = '';
            for (let i = 0; i < 40; i++) { progressBar.appendChild(document.createElement('div')).className = 'progress-block'; }
        }

        function updateProgressBar(progress) {
            const blocks = progressBar.children;
            const filledBlocks = Math.floor(progress * blocks.length);
            for (let i = 0; i < blocks.length; i++) { blocks[i].classList.toggle('filled', i < filledBlocks); }
        }
        
        function updateClock() { clockEl.textContent = new Date().toLocaleTimeString('pt-BR'); }
        
        function createVisualizerBars() {
            visualizerEl.innerHTML = '';
            for (let i = 0; i < 32; i++) {
                const bar = document.createElement('div');
                Object.assign(bar, { className: 'bg-gray-500 w-2', style: 'height: 2px; transition: height 0.1s;' });
                visualizerEl.appendChild(bar);
            }
        }
        
        function animateVisualizer() {
            if (isPlaying && !visualizerEl.classList.contains('hidden')) {
                const bars = visualizerEl.children;
                for (let i = 0; i < bars.length; i++) { bars[i].style.height = `${Math.random() * 100}%`; }
            }
            requestAnimationFrame(animateVisualizer);
        }

        // Tracklist Functions
        function showTracklist() {
            const album = albums[currentAlbumIndex];
            tracklistAlbumTitle.textContent = album.title;
            tracklistList.innerHTML = '';

            album.tracks.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = 'tracklist-item';
                item.textContent = `${String(index + 1).padStart(2, '0')}. ${track.title}`;
                if (playlist[currentTrackIndex] === index) {
                    item.classList.add('playing');
                }
                item.addEventListener('click', () => {
                    const playlistIndex = playlist.findIndex(i => i === index);
                    playTrack(playlistIndex);
                    hideTracklist();
                });
                tracklistList.appendChild(item);
            });

            tracklistModal.classList.remove('screen-hidden');
        }

        function hideTracklist() {
            tracklistModal.classList.add('screen-hidden');
        }

        // Modos
        function toggleSoundscape() {
             const track = albums[currentAlbumIndex].tracks[playlist[currentTrackIndex]];
             if (track.musicVideoId) {
                // BUG FIX: O player de fullscreen é sempre mudo. Apenas carrega e sincroniza o vídeo.
                if (fullscreenVideoPlayer && typeof fullscreenVideoPlayer.loadVideoById === 'function') {
                    fullscreenVideoPlayer.loadVideoById({ videoId: track.musicVideoId, startSeconds: player.getCurrentTime() });
                    fullscreenVideoPlayer.mute(); // Garante que está mudo
                }
                showScreen(fullscreenVideoMode);
             } else { 
                showScreen(soundscapeMode); 
             }
        }
        
        function exitSoundscape() { showScreen(playerScreen); }
        
        function exitFullscreen() {
            // BUG FIX: Para o vídeo de fullscreen e garante que o áudio principal não foi afetado.
            if(fullscreenVideoPlayer && typeof fullscreenVideoPlayer.stopVideo === 'function') {
                fullscreenVideoPlayer.stopVideo();
            }
            showScreen(playerScreen);
        }
        
        // Screensaver
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            if (!dvdScreensaver.classList.contains('screen-hidden')) { hideDvdScreensaver(); }
            inactivityTimer = setTimeout(showDvdScreensaver, 120000);
        }

        let dvd = { x: 50, y: 50, vx: 2, vy: 2, logo: dvdLogo };
        let dvdAnimation;

        function showDvdScreensaver() {
            dvdScreensaver.classList.remove('screen-hidden');
            dvdAnimation = requestAnimationFrame(animateDvdLogo);
        }
        
        function hideDvdScreensaver() {
            dvdScreensaver.classList.add('screen-hidden');
            cancelAnimationFrame(dvdAnimation);
        }

        function animateDvdLogo() {
            const screenW = window.innerWidth, screenH = window.innerHeight;
            const logoW = dvd.logo.offsetWidth, logoH = dvd.logo.offsetHeight;
            dvd.x += dvd.vx; dvd.y += dvd.vy;
            if (dvd.x + logoW >= screenW || dvd.x <= 0) { dvd.vx *= -1; dvd.logo.style.color = `hsl(${Math.random() * 360}, 100%, 75%)`; }
            if (dvd.y + logoH >= screenH || dvd.y <= 0) { dvd.vy *= -1; dvd.logo.style.color = `hsl(${Math.random() * 360}, 100%, 75%)`; }
            dvd.logo.style.left = `${dvd.x}px`; dvd.logo.style.top = `${dvd.y}px`;
            dvdAnimation = requestAnimationFrame(animateDvdLogo);
        }

        // Inicialização
        window.onload = () => {
            // Carregar API do YouTube
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.getElementsByTagName('script')[0].parentNode.insertBefore(tag, document.getElementsByTagName('script')[0]);
            
            // Inicializar UI
            initializeCDSelection(); 
            createProgressBar(); 
            createVisualizerBars();
            setInterval(updateClock, 1000); 
            updateClock(); 
            requestAnimationFrame(animateVisualizer);
            
            // Configurar Inatividade
            resetInactivityTimer();
            ['mousemove', 'keypress', 'click'].forEach(evt => document.addEventListener(evt, resetInactivityTimer));

            // Event Listeners (Garantir que os elementos existem)
            if(volumeSlider) {
                volumeSlider.addEventListener('input', (e) => {
                    if(player && typeof player.setVolume === 'function') player.setVolume(e.target.value);
                });
            }
            if(backBtn) backBtn.addEventListener('click', () => {
                stopPlayback(); showScreen(selectionScreen);
                document.documentElement.style.setProperty('--album-theme-color', 'var(--ps2-blue)');
            });
            if(playBtn) playBtn.addEventListener('click', () => player.playVideo());
            if(pauseBtn) pauseBtn.addEventListener('click', () => player.pauseVideo());
            if(stopBtn) stopBtn.addEventListener('click', stopPlayback);
            if(nextBtn) nextBtn.addEventListener('click', playNext);
            if(prevBtn) prevBtn.addEventListener('click', playPrev);
            if(rewindBtn) rewindBtn.addEventListener('click', () => seekRelative(-5));
            if(forwardBtn) forwardBtn.addEventListener('click', () => seekRelative(5));
            if(shuffleBtn) shuffleBtn.addEventListener('click', toggleShuffle);
            if(repeatBtn) repeatBtn.addEventListener('click', toggleRepeat);
            if(vizBtn) vizBtn.addEventListener('click', () => { visualizerEl.classList.toggle('hidden'); vizBtn.classList.toggle('active'); });
            if(soundscapeBtn) soundscapeBtn.addEventListener('click', toggleSoundscape);
            if(exitSoundscapeBtn) exitSoundscapeBtn.addEventListener('click', exitSoundscape);
            if(exitFullscreenBtn) exitFullscreenBtn.addEventListener('click', exitFullscreen);
            if(tracklistBtn) tracklistBtn.addEventListener('click', showTracklist);
            if(closeTracklistBtn) closeTracklistBtn.addEventListener('click', hideTracklist);

            if(progressBar) progressBar.addEventListener('click', (e) => {
                const barWidth = progressBar.offsetWidth;
                const clickX = e.offsetX;
                const progress = clickX / barWidth;
                const duration = player.getDuration();
                if (duration > 0) {
                    const newTime = duration * progress;
                    player.seekTo(newTime, true);
                    // BUG FIX: Sincroniza o vídeo de fundo ao clicar na barra
                    if(videoBgPlayer && typeof videoBgPlayer.seekTo === 'function') {
                        videoBgPlayer.seekTo(newTime, true);
                    }
                }
            });
        };
    </script>
</body>
</html>
