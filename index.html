<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS2 Music Player Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --ps2-bg: #5f5f6e;
            --ps2-yellow: #ffff00;
            --ps2-blue: #0096ff;
            --ps2-white: #e0e0e0;
            --ps2-dark-grey: #4a4a58;
        }

        /* Animações Keyframes */
        @keyframes spin-2d { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
        @keyframes scanlines { 0% { background-position: 0 0; } 100% { background-position: 0 50px; } }
        @keyframes cd-glare { 0% { transform: translateX(-200%) skewX(-30deg); opacity: 0.2; } 50% { opacity: 0.4; } 100% { transform: translateX(200%) skewX(-30deg); opacity: 0.2;} }
        @keyframes jitter-subtle { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(0.2px, -0.2px); } 50% { transform: translate(-0.2px, 0.2px); } 75% { transform: translate(0.2px, 0.2px); } }
        @keyframes background-pan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 255, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 0, 0); } }
        @keyframes vhs-jitter { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-1px, 1px); } 50% { transform: translate(1px, -1px); } 75% { transform: translate(-1px, -1px); } }
        @keyframes vhs-scanlines { 0% { background-position: 0 100%; } 100% { background-position: 0 0; } }
        @keyframes dvd-bounce {
            0%, 100% { top: 0; left: 0; }
            25% { top: calc(100% - 100px); left: calc(100% - 150px); }
            50% { top: calc(100% - 100px); left: 0; }
            75% { top: 0; left: calc(100% - 150px); }
        }

        body { background-color: #111; font-family: 'VT323', monospace; color: var(--ps2-white); overflow: hidden; }
        
        .crt-filter {
            position: relative; width: 100vw; height: 100vh;
            filter: blur(0.7px) contrast(1.2) saturate(1.5);
            animation: jitter-subtle 0.2s infinite;
        }
        .crt-filter::before, .crt-filter::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 2; pointer-events: none; }
        .crt-filter::before {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 4px 100%;
            animation: scanlines 0.2s infinite linear;
        }
        .crt-filter::after { box-shadow: inset 0 0 120px rgba(0,0,0,0.6); }
        
        body.vhs-active .crt-filter {
            animation: vhs-jitter 0.15s infinite;
            filter: blur(1.5px) contrast(1.5) saturate(2.0);
        }
        body.vhs-active .crt-filter::before {
            background-size: 100% 8px, 8px 100%;
            animation: vhs-scanlines 0.1s infinite linear;
        }
        
        #noise-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIj48ZmlsdGVyIGlkPSJub2lzZSI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuOCIgbnVtT2N0YXZlcz0iNCIgc3RpdGNoVGlsZXM9InN0aXRjaCIvPjwvZmlsdGVyPjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWx0ZXI9InVybCgjbm9pc2UpIiBvcGFjaXR5PSIwLjE1Ii8+PC9zdmc+');
            pointer-events: none; z-index: 3;
        }

        .screen {
            background-color: var(--ps2-bg); position: absolute; width: 100%; height: 100%; display: flex;
            align-items: center; justify-content: center; transition: opacity 0.5s, visibility 0.5s;
            opacity: 0; visibility: hidden;
        }
        .screen.active { opacity: 1; visibility: visible; animation: fadeIn 0.5s ease-out; }
        .screen.hiding { animation: fadeOut 0.5s ease-in; }

        #selection-screen {
            background-image: radial-gradient(circle, rgba(0, 50, 100, 0.3) 0%, transparent 70%), radial-gradient(circle, rgba(100, 0, 50, 0.2) 100%, transparent 70%);
            animation: background-pan 40s infinite linear;
        }
        #selection-bg-hover {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            opacity: 0; transition: opacity 0.5s ease-in-out;
            z-index: 0;
        }
        .cd-selection-item {
            position: relative; width: 220px; height: 220px;
            cursor: pointer; transition: transform 0.3s ease;
            perspective: 1000px;
        }
        .cd-case {
            width: 100%; height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s ease;
        }
        .cd-selection-item:hover .cd-case {
            transform: rotateY(-25deg);
        }
        .cd-front-cover {
            position: absolute;
            width: 100%; height: 100%;
            background: linear-gradient(45deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05));
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            backface-visibility: hidden;
        }
        .cd-spine {
            position: absolute;
            width: 25px; height: 100%;
            background-color: #ccc;
            background-image: linear-gradient(to right, #aaa, #ddd, #aaa);
            transform: rotateY(90deg) translateZ(-12.5px);
            border-radius: 8px 0 0 8px;
        }
        #selection-screen .cd-art {
            position: absolute;
            top: 50%; left: 50%;
            width: 95%; height: 95%;
            transform: translate(-50%, -50%);
            border-radius: 50%; background-size: cover; background-position: center;
        }

        #player-screen { background-color: transparent; transition: background-color 0.5s, background-image 0.5s; }
        #video-background-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: -1; opacity: 0; transition: opacity 0.8s ease-in-out;
            background-color: #000;
        }
        #video-background-container.visible { opacity: 0.3; }
        #video-background-container.blue-tint::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: blue;
            mix-blend-mode: color;
            opacity: 0.3;
        }
        #player-screen.fullscreen-video #video-background-container.visible { opacity: 1; }

        #youtube-player-iframe, #youtube-videoclip-iframe {
            position: absolute; top: 50%; left: 50%;
            width: 120%; height: 120%;
            transform: translate(-50%, -50%) scale(1.05);
        }

        .player-container { width: 100%; max-width: 1152px; margin: auto; position: relative; z-index: 5; transition: opacity 0.5s ease; }
        #player-screen.fullscreen-video .player-container, #player-screen.soundscape-mode .player-container { opacity: 0; pointer-events: none; }
        
        .cd-2d-container { width: 320px; height: 320px; }
        .cd-2d {
            width: 100%; height: 100%; border-radius: 50%; position: relative; background-size: cover; background-position: center;
            box-shadow: 0 0 35px rgba(0,0,0,0.6); 
            animation: spin-2d 15s linear infinite;
            animation-play-state: paused;
            transition: transform 0.5s ease-out;
            overflow: hidden;
        }
        .cd-2d.playing { animation-play-state: running; }
        .cd-2d::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.35) 50%, rgba(255,255,255,0) 100%);
            animation: cd-glare 3s linear infinite;
        }
        .cd-hole {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80px; height: 80px; border-radius: 50%; background-color: var(--ps2-bg);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.7);
            z-index: 1;
        }
        
        .player-container .animated-ui { opacity: 0; transform: translateY(15px); transition: opacity 0.5s ease, transform 0.5s ease; }
        .player-container.ui-ready .animated-ui { opacity: 1; transform: translateY(0); }
        .player-container.ui-ready .cd-2d-container { transition-delay: 0.1s; }
        .player-container.ui-ready #visualizer { transition-delay: 0.2s; }
        .player-container.ui-ready .track-info { transition-delay: 0.3s; }
        .player-container.ui-ready .extra-controls { transition-delay: 0.4s; }
        .player-container.ui-ready #back-btn { transition-delay: 0.5s; }

        .track-info { font-size: 1.5rem; line-height: 1.75rem; }
        .track-number { color: var(--ps2-yellow); font-weight: bold; font-size: 2.25rem; }
        .track-name-wrapper { overflow: hidden; white-space: nowrap; }
        .track-name { font-size: 1.875rem; min-height: 56px; display: inline-block; }
        .track-name.scrolling { animation: marquee 10s linear infinite; }
        .time-display { font-size: 1.5rem; }

        .progress-bar-container { display: flex; gap: 2px; width: 100%; height: 20px; cursor: pointer; }
        .progress-block { flex-grow: 1; background-color: var(--ps2-dark-grey); }
        .progress-block.active { background-color: var(--ps2-blue); }

        .controls button, .extra-controls button {
            background: none; border: 2px solid transparent; padding: 4px 8px; opacity: 0.8; transition: all 0.3s ease; cursor: pointer;
        }
        .controls svg { width: 28px; height: 28px; fill: var(--ps2-white); }
        .controls .play-icon { fill: var(--ps2-blue); }
        .controls button:hover, .extra-controls button:hover { opacity: 1; border-color: var(--ps2-white); }
        .controls button.active, .extra-controls button.active { color: var(--ps2-yellow); border-color: var(--ps2-yellow); }
        
        #soundscape-btn.active { animation: pulse-border 2s infinite; }

        #soundscape-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 10;
            cursor: pointer;
        }
        #soundscape-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            transition: background-image 0.5s ease;
            filter: saturate(2.5) blur(8px) contrast(1.5);
            opacity: 0.35;
            transform: scale(1.1);
        }
        #player-screen.soundscape-mode #soundscape-overlay { opacity: 1; pointer-events: all; }
        #soundscape-overlay .cd-2d { width: 400px; height: 400px; box-shadow: 0 0 50px rgba(255, 255, 255, 0.3); }
        #soundscape-overlay .time-display { 
            background-color: rgba(0,0,0,0.6); 
            padding: 8px 20px; 
            border-radius: 8px; 
            margin-top: 2.5rem; 
            font-size: 2.25rem; 
            border: 1px solid rgba(255,255,255,0.2);
            text-shadow: 0 0 5px rgba(0, 150, 255, 0.7);
        }
        
        .exit-mode-btn {
            position: absolute; top: 2rem; right: 2rem;
            font-size: 2rem; color: var(--ps2-white);
            background-color: rgba(0,0,0,0.5);
            border: 2px solid var(--ps2-white);
            border-radius: 50%;
            width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
            z-index: 15;
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
        }
        .exit-mode-btn:hover {
            transform: scale(1.1);
            color: var(--ps2-yellow);
            border-color: var(--ps2-yellow);
            box-shadow: 0 0 15px var(--ps2-yellow);
        }
        #player-screen.soundscape-mode #exit-soundscape-btn,
        #player-screen.fullscreen-video #exit-fullscreen-btn {
             opacity: 1;
             pointer-events: all;
        }

        #dvd-screensaver {
            position: absolute; top: 0; left: 0;
            width: 150px; height: 100px;
            z-index: 9999;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s;
        }
        #dvd-screensaver.active {
            opacity: 1;
            animation: dvd-bounce 10s linear infinite;
        }
        #dvd-logo {
            width: 100%; height: 100%;
            background-color: white;
            -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 208 128"><path d="M16,32h32v64h-32v-64Z M160,32h32v64h-32v-64Z M80,32h32v64h-32v-64Z"/></svg>') no-repeat center;
            mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 208 128"><path d="M16,32h32v64h-32v-64Z M160,32h32v64h-32v-64Z M80,32h32v64h-32v-64Z"/></svg>') no-repeat center;
        }

        .popup {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(40,40,60,0.95); border: 2px solid var(--ps2-blue);
            max-height: 80%; width: 80%; max-width: 500px; z-index: 20;
            backdrop-filter: blur(5px);
            transition: opacity 0.3s, transform 0.3s;
        }
        .popup.hidden { opacity: 0; transform: translate(-50%, -45%); pointer-events: none; }
        
        #visualizer { width: 100%; height: 60px; }
        
        #cd-transition-element {
            position: fixed; z-index: 100; border-radius: 50%;
            background-size: cover; background-position: center;
            transition: all 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            will-change: top, left, width, height, transform;
        }

    </style>
</head>
<body class="theme-default">

    <div class="crt-filter">
        <div id="noise-overlay"></div>
        
        <div id="selection-screen" class="screen active">
            <div id="selection-bg-hover"></div>
            <div class="text-center relative z-10">
                <h1 class="text-5xl text-white mb-12" style="text-shadow: 2px 2px 0 var(--ps2-blue);">Select Disc</h1>
                <div id="cd-selection-container" class="flex flex-wrap justify-center gap-8 px-4"></div>
            </div>
        </div>
        
        <div id="player-screen" class="screen">
            <div id="video-background-container">
                 <div id="youtube-videoclip-iframe" class="pointer-events-none"></div>
            </div>

            <div id="soundscape-overlay">
                <div id="soundscape-bg"></div>
                <button id="exit-soundscape-btn" class="exit-mode-btn">X</button>
                <div id="soundscape-cd" class="cd-2d z-10">
                    <div class="cd-hole"></div>
                </div>
                <p id="soundscape-time" class="time-display z-10">00:00 / 00:00</p>
            </div>
            
            <button id="exit-fullscreen-btn" class="exit-mode-btn">Back</button>

            <div id="clock" class="absolute top-4 right-4 text-2xl z-20"></div>
            <div id="player-container" class="player-container p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div class="flex flex-col items-center gap-4">
                        <div class="cd-2d-container animated-ui">
                            <div id="cd-2d" class="cd-2d">
                                <div class="cd-hole"></div>
                            </div>
                        </div>
                        <canvas id="visualizer" class="animated-ui"></canvas>
                    </div>

                    <div class="flex flex-col justify-between h-full space-y-4">
                        <div class="track-info text-center md:text-left space-y-2 animated-ui">
                            <h2 id="track-number" class="track-number">Track 01</h2>
                            <div class="track-name-wrapper"><p id="track-name" class="track-name">Loading...</p></div>
                            <div id="progress-bar-container" class="progress-bar-container"></div>
                            <p id="time-display" class="time-display">00:00 / 00:00</p>
                            
                            <div class="controls flex items-center justify-center md:justify-start space-x-1">
                                <button id="rewind-btn" title="Rewind 10s"><svg viewBox="0 0 24 24"><path d="M11 18V6l-8.5 6 8.5 6zm-2-6l6-4.5v9l-6-4.5z"/></svg></button>
                                <button id="prev-btn" title="Previous Track"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                                <button id="play-btn" title="Play"><svg class="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                                <button id="pause-btn" title="Pause" class="hidden"><svg class="play-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg></button>
                                <button id="stop-btn" title="Stop"><svg viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg></button>
                                <button id="next-btn" title="Next Track"><svg viewBox="0 0 24 24"><path d="M16 6h2v12h-2zm-3.5 6l-8.5 6V6z"/></svg></button>
                                <button id="forward-btn" title="Forward 10s"><svg viewBox="0 0 24 24"><path d="M13 6v12l8.5-6-8.5-6zm-2 6l-6 4.5v-9l6 4.5z"/></svg></button>
                            </div>
                        </div>
                        <div class="extra-controls flex items-center justify-between w-full animated-ui">
                             <div class="flex gap-2">
                                <button id="tracklist-btn" class="text-lg">Track List</button>
                                <button id="shuffle-btn" class="text-lg">Shuffle</button>
                                <button id="repeat-btn" class="text-lg">Repeat All</button>
                             </div>
                             <div class="flex items-center gap-4">
                                <button id="viz-btn" class="text-lg">Viz: Bars</button>
                                <button id="soundscape-btn" class="text-lg">Soundscape</button>
                                <input id="volume-slider" type="range" min="0" max="100" value="80" class="volume-slider w-24">
                             </div>
                        </div>
                    </div>
                </div>
                <div id="back-btn" class="footer-prompts flex justify-end space-x-8 mt-4 cursor-pointer animated-ui">
                    <div><span class="prompt-icon" style="color: #ff4444; border-color: #ff4444;">O</span> Back</div>
                </div>
            </div>
        </div>
        <div id="dvd-screensaver"><div id="dvd-logo"></div></div>
    </div>

    <div id="youtube-player-iframe" class="absolute -left-full top-0"></div>
    <div id="tracklist-popup" class="popup p-4 hidden">
        <h3 id="tracklist-title" class="text-2xl text-center mb-4 text-yellow-300"></h3>
        <ul id="tracklist-ul" class="overflow-y-auto max-h-64 text-lg"></ul>
        <button id="close-tracklist-btn" class="absolute top-2 right-2 text-2xl">X</button>
    </div>

    <script>
        // Main application state
        const AppState = {
            albums: [
                {
                    id: 'validation',
                    name: "Validation",
                    coverUrl: "https://i1.sndcdn.com/artworks-zMJy5oUhjfM05LnK-AzuGwA-t500x500.jpg",
                    theme: { name: 'validation', primary: '#66ff66', secondary: '#00529b', bg: 'rgba(0, 82, 155, 0.2)' },
                    tracks: [
                        { audioId: 'tkl_smLRtcE', title: "Sucesso FM", musicVideoId: 'tqdOIs3K-SA' }, 
                        { audioId: 'gTsZ-vQLq74', title: "Rumo a Vitória" },
                        { audioId: 'fGhkeEmMDSU', title: "Goddamn" }, 
                        { audioId: 'pKyoxG2ZDh8', title: "I Walk", musicVideoId: 'lvABzBQDYGY' },
                        { audioId: '-1WfKz06Hgc', title: "Waiting to Fly", musicVideoId: 'hX2NJxJP6Mc' }, 
                        { audioId: 'llJZ4H4zQ2k', title: "Sonhar", musicVideoId: 'WCtvzfzKStU', videoStart: 39 },
                        { audioId: 'TQ2OtyCtOMc', title: "I'm in Love" }, 
                        { audioId: 'u3M_KURTWKY', title: "For my Family", musicVideoId: 'krU-M8WusuY' }, 
                        { audioId: 'm8SzrWpCjKU', title: "Going Home" }, 
                        { audioId: 'rfIV2uGZ2kM', title: "The Lord and Me" },
                        { audioId: 'ozu12D-DdJk', title: "Anjos da Guarda", musicVideoId: 'gI_2-LacLiI' }, 
                        { audioId: 'HjA6fwTInT0', title: "We Gold" },
                    ]
                },
                {
                    id: 'bittersweet',
                    name: "Bittersweet Memories",
                    coverUrl: "https://i.scdn.co/image/ab67616d0000b2732e8e4cfa666ea534d070c041",
                    theme: { name: 'bittersweet', primary: '#ff8c00', secondary: '#ffd700', bg: 'rgba(255, 140, 0, 0.2)' },
                    tracks: [
                        { audioId: 'xXeDMfisrU8', title: "Saúde" }, { audioId: 'rsxeE1WkHqw', title: "Filho Pródigo" },
                        { audioId: 'KzUUemEW_iI', title: "Let It Pour" }, { audioId: 'qkaxqSGI_OE', title: "The Story" },
                        { audioId: 'fnRyVCxqLqk', title: "Back Home" }, { audioId: 'RMeJND0yzeM', title: "Melhor Não" },
                        { audioId: 'yApMEdYtkGM', title: "Old School" }, { audioId: 'ZBe3GmoFJys', title: "Dirty Dancing" },
                        { audioId: 'g0_DLkqjylU', title: "Prefiro Morrer" },
                        { audioId: 'vLQR5UCq5J0', title: "Quase Perfeito" }, 
                        { audioId: 'Z7LsJA7NJF0', title: "Máquina do Tempo", musicVideoId: 'Z7LsJA7NJF0' },
                        { audioId: 'tR-m63k2nNM', title: "Flores de Outro Carnaval" },
                    ]
                },
                {
                    id: '13lentes',
                    name: "13 lentes de um final feliz",
                    coverUrl: "https://cdn-images.dzcdn.net/images/cover/a01cc5f5bbb09711637d4927e9ab83cd/500x500.jpg",
                    theme: { name: '13-lentes', primary: '#ffffff', secondary: '#888888', bg: 'rgba(128, 128, 128, 0.2)' },
                    tracks: [
                        { audioId: 'asI5cHpQPAA', title: "Au revoir" }, { audioId: 'wRlhPzhgqu0', title: "Carruagem" },
                        { audioId: 'GPemhYrDATw', title: "Agradeço" }, { audioId: 'mNlhepSXi4g', title: "Corrida" },
                        { audioId: 'WlylgE8fSLs', title: "Joias da Familia" }, 
                        { audioId: 'TSLRScqwemI', title: "Nunca Paro", musicVideoId: 'P9NqaluDZuk', videoLoop: true },
                        { audioId: 'GC-BHmtlhFQ', title: "Memórias" }, { audioId: '6ep0itQcsUM', title: "Lost in Translation" },
                        { audioId: 'nKJyKsFgDJY', title: "Primavera" }, { audioId: 'MVrIi0zI6gc', title: "Let me see the sun" },
                        { audioId: 'vWsdkDa3vOw', title: "Adeus" }, { audioId: 'cgW6sqr8X0k', title: "Deixa Doer" },
                        { audioId: 'lUu0sFJfN80', title: "Não me faça falar", musicVideoId: 'Ryz5LuaFznM' },
                    ]
                },
                {
                    id: 'optica',
                    name: "Óptica",
                    coverUrl: "https://images.genius.com/a1c5e0cebf8fdb9629ff8205d02af9ff.1000x1000x1.png",
                    theme: { name: 'optica', primary: '#add8e6', secondary: '#ffffff', bg: 'rgba(173, 216, 230, 0.2)' },
                    tracks: [
                        { audioId: 'DWV5g3m3118', title: "Absorver" }, { audioId: 'YbQj7ByNkNM', title: "Reflexo" },
                        { audioId: 'ENmHHlGVAtE', title: "Sombra", musicVideoId: '1EYOFvZmnJE' },
                        { audioId: 'd-mQtP2JHJY', title: "Transparência" }
                    ]
                },
                {
                    id: 'bonstempos',
                    name: "Bons tempos",
                    coverUrl: "https://akamai.sscdn.co/uploadfile/letras/albuns/3/0/9/c/2338071724245865.jpg",
                    theme: { name: 'bonstempos', primary: '#9370db', secondary: '#e6e6fa', bg: 'rgba(75, 0, 130, 0.3)', bgImage: 'url(https://www.transparenttextures.com/patterns/stardust.png)' },
                    tracks: [
                        { audioId: 'XUYNTXXhmbc', title: 'Quando a noite vem' },
                        { audioId: 'wwVejlwrKTA', title: 'Oxford Shoes' },
                        { audioId: 'R3BWRueflA4', title: 'Twist', musicVideoId: 'hcL33v1N8uQ', videoLoop: true },
                        { audioId: '61o4MC3kEsM', title: 'American Dream' },
                        { audioId: 'MUqryi1MIrs', title: 'A Cidade sem você' },
                        { audioId: 'amC0UxaMz9Y', title: 'Um certo alguem' },
                        { audioId: 'slgXDu2Ck2A', title: 'Playback' },
                        { audioId: 'wVmcDQ_yX5g', title: 'Amiga fiel' },
                        { audioId: 'yqRAcdaqLNI', title: 'Televisão' },
                        { audioId: 'y1v-bI4_k2I', title: 'Raise my hands' }
                    ]
                }
            ],
            
            currentAlbumIndex: 0,
            currentTrackIndex: 0,
            audioPlayer: null,
            videoPlayer: null,
            progressInterval: null,
            isApiLoaded: false,
            isPlayerReady: false,
            isShuffle: false,
            repeatMode: 'all',
            visualizerMode: 'bars',
            clockInterval: null,
            isSoundscapeMode: false,
            screensaverTimeout: null,
            bgHoverTimeout: null,
            visualizerId: null
        };

        // DOM elements
        const DOM = {
            body: document.body,
            selectionScreen: document.getElementById('selection-screen'),
            selectionBgHover: document.getElementById('selection-bg-hover'),
            playerScreen: document.getElementById('player-screen'),
            videoBgContainer: document.getElementById('video-background-container'),
            playerContainer: document.getElementById('player-container'),
            cdSelectionContainer: document.getElementById('cd-selection-container'),
            cd2d: document.getElementById('cd-2d'),
            soundscapeOverlay: document.getElementById('soundscape-overlay'),
            soundscapeBg: document.getElementById('soundscape-bg'),
            soundscapeCd: document.getElementById('soundscape-cd'),
            soundscapeTime: document.getElementById('soundscape-time'),
            exitSoundscapeBtn: document.getElementById('exit-soundscape-btn'),
            exitFullscreenBtn: document.getElementById('exit-fullscreen-btn'),
            dvdScreensaver: document.getElementById('dvd-screensaver'),
            playBtn: document.getElementById('play-btn'),
            pauseBtn: document.getElementById('pause-btn'),
            stopBtn: document.getElementById('stop-btn'),
            nextBtn: document.getElementById('next-btn'),
            prevBtn: document.getElementById('prev-btn'),
            backBtn: document.getElementById('back-btn'),
            rewindBtn: document.getElementById('rewind-btn'),
            forwardBtn: document.getElementById('forward-btn'),
            shuffleBtn: document.getElementById('shuffle-btn'),
            repeatBtn: document.getElementById('repeat-btn'),
            vizBtn: document.getElementById('viz-btn'),
            soundscapeBtn: document.getElementById('soundscape-btn'),
            trackNumber: document.getElementById('track-number'),
            trackName: document.getElementById('track-name'),
            timeDisplay: document.getElementById('time-display'),
            progressBarContainer: document.getElementById('progress-bar-container'),
            volumeSlider: document.getElementById('volume-slider'),
            tracklistBtn: document.getElementById('tracklist-btn'),
            tracklistPopup: document.getElementById('tracklist-popup'),
            tracklistTitle: document.getElementById('tracklist-title'),
            tracklistUl: document.getElementById('tracklist-ul'),
            closeTracklistBtn: document.getElementById('close-tracklist-btn'),
            visualizer: document.getElementById('visualizer'),
            clock: document.getElementById('clock')
        };

        // Utility functions
        const Utils = {
            formatTime: (seconds) => {
                seconds = Math.floor(seconds) || 0;
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            },
            
            fadeOutAudio: (callback) => {
                const currentVolume = DOM.volumeSlider.value;
                if (currentVolume == 0) { if(callback) callback(); return; }
                let fadeVolume = currentVolume;
                const fadeOutInterval = setInterval(() => {
                    fadeVolume -= 5;
                    if (fadeVolume <= 0) {
                        clearInterval(fadeOutInterval);
                        if(callback) callback();
                        setTimeout(() => AppState.audioPlayer.setVolume(currentVolume), 500);
                    } else {
                        AppState.audioPlayer.setVolume(fadeVolume);
                    }
                }, 50);
            }
        };

        // Screen management
        const ScreenManager = {
            transitionToScreen: (targetScreen, isAnimatingCD = false) => {
                const currentScreen = document.querySelector('.screen.active');
                if (currentScreen) {
                    currentScreen.classList.add('hiding');
                    setTimeout(() => currentScreen.classList.remove('active', 'hiding'), 500);
                }
                targetScreen.classList.add('active');
                if (isAnimatingCD) {
                    DOM.playerContainer.classList.remove('ui-ready');
                }
                if(targetScreen === DOM.playerScreen) ClockManager.startClock();
                else ClockManager.stopClock();
            },
            
            renderSelectionScreen: () => {
                DOM.cdSelectionContainer.innerHTML = '';
                AppState.albums.forEach((album, index) => {
                    const item = document.createElement('div');
                    item.className = 'cd-selection-item';
                    item.innerHTML = `
                        <div class="cd-case">
                            <div class="cd-spine"></div>
                            <div class="cd-front-cover">
                               <div class="cd-art" style="background-image: url('${album.coverUrl}')"></div>
                            </div>
                        </div>`;
                    item.onclick = (e) => PlayerManager.selectAlbum(index, e.currentTarget);
                    item.onmouseenter = () => {
                        if(AppState.bgHoverTimeout) clearTimeout(AppState.bgHoverTimeout);
                        DOM.selectionBgHover.style.backgroundImage = `url('${album.coverUrl}')`;
                        DOM.selectionBgHover.style.opacity = 0.2;
                    };
                    DOM.cdSelectionContainer.appendChild(item);
                });
            }
        };

        // Clock management
        const ClockManager = {
            startClock: () => {
                if (AppState.clockInterval) clearInterval(AppState.clockInterval);
                AppState.clockInterval = setInterval(() => {
                    const now = new Date();
                    DOM.clock.textContent = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                }, 1000);
            },
            
            stopClock: () => {
                clearInterval(AppState.clockInterval);
            }
        };

        // Screensaver management
        const ScreensaverManager = {
            resetScreensaverTimer: () => {
                clearTimeout(AppState.screensaverTimeout);
                DOM.dvdScreensaver.classList.remove('active');
                AppState.screensaverTimeout = setTimeout(() => {
                    DOM.dvdScreensaver.classList.add('active');
                }, 120000); // 2 minutes
            }
        };

        // Player management
        const PlayerManager = {
            loadYouTubeAPI: () => {
                if (AppState.isApiLoaded) return;
                AppState.isApiLoaded = true;
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                document.head.appendChild(tag);
            },
            
            selectAlbum: (index, clickedElement) => {
                AppState.currentAlbumIndex = index;
                AppState.currentTrackIndex = 0;
                
                const album = AppState.albums[index];
                const startRect = clickedElement.getBoundingClientRect();
                
                const transitionCD = document.createElement('div');
                transitionCD.id = 'cd-transition-element';
                transitionCD.style.backgroundImage = `url('${album.coverUrl}')`;
                transitionCD.style.left = `${startRect.left}px`;
                transitionCD.style.width = `${startRect.width}px`;
                transitionCD.style.height = `${startRect.height}px`;
                transitionCD.style.top = `${startRect.top}px`;
                document.body.appendChild(transitionCD);

                ScreenManager.transitionToScreen(DOM.playerScreen, true);
                
                requestAnimationFrame(() => {
                    const targetRect = DOM.cd2d.getBoundingClientRect();
                    transitionCD.style.left = `${targetRect.left}px`;
                    transitionCD.style.top = `${targetRect.top}px`;
                    transitionCD.style.width = `${targetRect.width}px`;
                    transitionCD.style.height = `${targetRect.height}px`;
                    transitionCD.style.transform = 'rotate(720deg)';

                    transitionCD.addEventListener('transitionend', () => {
                        transitionCD.remove();
                        DOM.playerContainer.classList.add('ui-ready');
                        if (!AppState.isApiLoaded) PlayerManager.loadYouTubeAPI();
                        else if (!AppState.audioPlayer || !AppState.isPlayerReady) window.onYouTubeIframeAPIReady();
                        else PlayerManager.loadTrack(AppState.currentTrackIndex, true);
                    }, { once: true });
                });
            },
            
            returnToSelection: () => {
                PlayerManager.exitAllModes();
                DOM.playerContainer.classList.remove('ui-ready');
                Utils.fadeOutAudio(PlayerManager.stopMusic);
                PlayerManager.resetTheme();
                ScreenManager.transitionToScreen(DOM.selectionScreen);
            },
            
            loadTrack: (index, autoplay = false) => {
                if (!AppState.isPlayerReady) return;
                PlayerManager.exitAllModes();
                const album = AppState.albums[AppState.currentAlbumIndex];
                if (index < 0 || index >= album.tracks.length) return;
                const track = album.tracks[index];
                AppState.currentTrackIndex = index;

                PlayerManager.applyTheme(album.theme);
                PlayerManager.updateTrackInfo(album, track, index + 1);
                
                DOM.body.classList.toggle('vhs-active', track.title === 'Máquina do Tempo');
                DOM.videoBgContainer.classList.toggle('blue-tint', album.id === 'validation');
                
                const audioPlayerVars = {
                    'videoId': track.audioId,
                    'startSeconds': track.videoStart || 0,
                };
                
                if (autoplay) AppState.audioPlayer.loadVideoById(audioPlayerVars);
                else AppState.audioPlayer.cueVideoById(audioPlayerVars);

                if (track.musicVideoId) {
                    DOM.videoBgContainer.classList.add('visible');
                    const videoPlayerVars = {
                        'videoId': track.musicVideoId,
                        'startSeconds': track.videoStart || 0,
                        'loop': track.videoLoop ? 1 : 0,
                        'playlist': track.videoLoop ? track.musicVideoId : undefined
                    };
                    AppState.videoPlayer.loadVideoById(videoPlayerVars);
                } else {
                    DOM.videoBgContainer.classList.remove('visible');
                    if (AppState.videoPlayer && typeof AppState.videoPlayer.stopVideo === 'function') {
                        AppState.videoPlayer.stopVideo();
                    }
                }
            },
            
            playMusic: () => { 
                if (AppState.audioPlayer) AppState.audioPlayer.playVideo(); 
            },
            
            pauseMusic: () => { 
                Utils.fadeOutAudio(() => AppState.audioPlayer.pauseVideo()); 
            },
            
            stopMusic: () => {
                if (AppState.audioPlayer && typeof AppState.audioPlayer.stopVideo === 'function') {
                    Utils.fadeOutAudio(() => {
                        AppState.audioPlayer.stopVideo();
                        DOM.videoBgContainer.classList.remove('visible');
                    });
                }
                PlayerManager.updateUIIsPlaying(false);
            },
            
            playNextTrack: () => {
                if (AppState.repeatMode === 'one') { 
                    PlayerManager.loadTrack(AppState.currentTrackIndex, true); 
                    return; 
                }
                
                if (AppState.isShuffle) {
                    let nextIndex;
                    do { 
                        nextIndex = Math.floor(Math.random() * AppState.albums[AppState.currentAlbumIndex].tracks.length); 
                    } while (AppState.albums[AppState.currentAlbumIndex].tracks.length > 1 && nextIndex === AppState.currentTrackIndex);
                    PlayerManager.loadTrack(nextIndex, true);
                    return;
                }
                
                const isLastTrack = AppState.currentTrackIndex === AppState.albums[AppState.currentAlbumIndex].tracks.length - 1;
                if (isLastTrack && AppState.repeatMode === 'none') { 
                    PlayerManager.stopMusic(); 
                    return; 
                }
                
                const nextTrackIndex = (AppState.currentTrackIndex + 1) % AppState.albums[AppState.currentAlbumIndex].tracks.length;
                PlayerManager.loadTrack(nextTrackIndex, true);
            },
            
            playPrevTrack: () => { 
                PlayerManager.loadTrack(
                    (AppState.currentTrackIndex - 1 + AppState.albums[AppState.currentAlbumIndex].tracks.length) % 
                    AppState.albums[AppState.currentAlbumIndex].tracks.length, 
                    true
                ); 
            },
            
            seek: (seconds) => {
                if (!AppState.audioPlayer || typeof AppState.audioPlayer.getCurrentTime !== 'function') return;
                const newTime = AppState.audioPlayer.getCurrentTime() + seconds;
                AppState.audioPlayer.seekTo(newTime, true);
                if (AppState.videoPlayer && typeof AppState.videoPlayer.seekTo === 'function') {
                    AppState.videoPlayer.seekTo(newTime, true);
                }
            },
            
            applyTheme: (theme) => {
                document.documentElement.style.setProperty('--ps2-blue', theme.primary || '#0096ff');
                document.documentElement.style.setProperty('--ps2-yellow', theme.secondary || '#ffff00');
                DOM.playerScreen.style.backgroundColor = theme.bg || 'var(--ps2-bg)';
                DOM.playerScreen.style.backgroundImage = theme.bgImage || 'none';
            },
            
            resetTheme: () => {
                document.documentElement.style.setProperty('--ps2-blue', '#0096ff');
                document.documentElement.style.setProperty('--ps2-yellow', '#ffff00');
                DOM.playerScreen.style.backgroundColor = 'var(--ps2-bg)';
                DOM.playerScreen.style.backgroundImage = 'none';
                DOM.videoBgContainer.classList.remove('visible');
                DOM.body.classList.remove('vhs-active');
            },
            
            updateTrackInfo: (album, track, trackNumber) => {
                DOM.trackNumber.textContent = `Track ${String(trackNumber).padStart(2, '0')}`;
                DOM.trackName.textContent = track.title;
                const coverUrl = `url('${album.coverUrl}')`;
                DOM.cd2d.style.backgroundImage = coverUrl;
                DOM.soundscapeCd.style.backgroundImage = coverUrl;
                DOM.soundscapeBg.style.backgroundImage = coverUrl;
                DOM.trackName.classList.toggle('scrolling', track.title.length > 20);
            },
            
            updateUIIsPlaying: (playing) => {
                DOM.cd2d.classList.toggle('playing', playing);
                DOM.soundscapeCd.classList.toggle('playing', playing);
                DOM.playBtn.classList.toggle('hidden', playing);
                DOM.pauseBtn.classList.toggle('hidden', !playing);
            },
            
            updateTimeDisplay: (currentTime, duration) => {
                const timeText = `${Utils.formatTime(currentTime)} / ${Utils.formatTime(duration)}`;
                DOM.timeDisplay.textContent = timeText;
                DOM.soundscapeTime.textContent = timeText;
                PlayerManager.updateProgressBar(currentTime, duration);
            },
            
            updateProgressBar: (currentTime, duration) => {
                const percentage = duration > 0 ? (currentTime / duration) * 100 : 0;
                const blockCount = 40;
                const activeBlocks = Math.floor(blockCount * (percentage / 100));
                
                DOM.progressBarContainer.innerHTML = '';
                for (let i = 0; i < blockCount; i++) {
                    const block = document.createElement('div');
                    block.className = 'progress-block';
                    block.style.transition = `background-color 0.5s ease ${i * 15}ms`;
                    if (i < activeBlocks) block.classList.add('active');
                    block.onclick = (e) => {
                        e.stopPropagation();
                        const newTime = (i / blockCount) * duration;
                        PlayerManager.seek(newTime);
                    };
                    DOM.progressBarContainer.appendChild(block);
                }
            },
            
            startProgressUpdater: () => {
                PlayerManager.stopProgressUpdater();
                AppState.progressInterval = setInterval(() => {
                    if (AppState.audioPlayer && typeof AppState.audioPlayer.getCurrentTime === 'function') {
                        PlayerManager.updateTimeDisplay(
                            AppState.audioPlayer.getCurrentTime(), 
                            AppState.audioPlayer.getDuration()
                        );
                    }
                }, 500);
                VisualizerManager.drawVisualizer();
            },
            
            stopProgressUpdater: () => {
                clearInterval(AppState.progressInterval);
                VisualizerManager.stopVisualizer();
            },
            
            toggleSoundscapeMode: () => {
                const track = AppState.albums[AppState.currentAlbumIndex].tracks[AppState.currentTrackIndex];
                if (track.musicVideoId) {
                    DOM.playerScreen.classList.toggle('fullscreen-video');
                } else {
                    AppState.isSoundscapeMode = !AppState.isSoundscapeMode;
                    DOM.playerScreen.classList.toggle('soundscape-mode', AppState.isSoundscapeMode);
                }
                DOM.soundscapeBtn.classList.toggle('active', 
                    AppState.isSoundscapeMode || DOM.playerScreen.classList.contains('fullscreen-video')
                );
            },
            
            exitAllModes: () => {
                if (AppState.isSoundscapeMode) {
                    AppState.isSoundscapeMode = false;
                    DOM.playerScreen.classList.remove('soundscape-mode');
                }
                if (DOM.playerScreen.classList.contains('fullscreen-video')) {
                    DOM.playerScreen.classList.remove('fullscreen-video');
                }
                DOM.soundscapeBtn.classList.remove('active');
            }
        };

        // Tracklist management
        const TracklistManager = {
            showTracklist: () => {
                const album = AppState.albums[AppState.currentAlbumIndex];
                DOM.tracklistTitle.textContent = album.name;
                DOM.tracklistUl.innerHTML = '';
                album.tracks.forEach((track, index) => {
                    const li = document.createElement('li');
                    li.className = 'p-2 cursor-pointer tracklist-item transition-colors';
                    li.textContent = `${String(index + 1).padStart(2, '0')}. ${track.title}`;
                    if (index === AppState.currentTrackIndex) li.style.color = 'var(--ps2-yellow)';
                    li.onclick = () => { 
                        PlayerManager.loadTrack(index, true); 
                        TracklistManager.hideTracklist(); 
                    };
                    DOM.tracklistUl.appendChild(li);
                });
                DOM.tracklistPopup.classList.remove('hidden');
            },
            
            hideTracklist: () => { 
                DOM.tracklistPopup.classList.add('hidden'); 
            }
        };

        // Visualizer management
        const VisualizerManager = {
            drawVisualizer: () => {
                AppState.visualizerId = requestAnimationFrame(VisualizerManager.drawVisualizer);
                const ctx = DOM.visualizer.getContext('2d');
                const width = DOM.visualizer.width;
                const height = DOM.visualizer.height;
                ctx.clearRect(0, 0, width, height);
                if(DOM.playerScreen.classList.contains('soundscape-mode') || DOM.playerScreen.classList.contains('fullscreen-video')) return;
                
                const isPlaying = AppState.audioPlayer && AppState.audioPlayer.getPlayerState() === YT.PlayerState.PLAYING;
                ctx.fillStyle = document.documentElement.style.getPropertyValue('--ps2-blue');

                if (AppState.visualizerMode === 'bars') {
                    const barCount = 32;
                    const barWidth = width / barCount;
                    for (let i = 0; i < barCount; i++) {
                        const barHeight = isPlaying ? Math.random() * height : 2;
                        ctx.fillRect(i * barWidth, height - barHeight, barWidth - 2, barHeight);
                    }
                } 
            },
            
            stopVisualizer: () => {
                cancelAnimationFrame(AppState.visualizerId);
            }
        };

        // YouTube API callbacks
        window.onYouTubeIframeAPIReady = () => {
            AppState.audioPlayer = new YT.Player('youtube-player-iframe', {
                playerVars: { 'controls': 0, 'fs': 0, 'iv_load_policy': 3, 'modestbranding': 1, 'rel': 0, 'showinfo': 0, 'autoplay': 1 },
                events: { 'onReady': PlayerManager.onPlayerReady, 'onStateChange': PlayerManager.onAudioPlayerStateChange }
            });
            AppState.videoPlayer = new YT.Player('youtube-videoclip-iframe', {
                playerVars: { 'controls': 0, 'fs': 0, 'iv_load_policy': 3, 'modestbranding': 1, 'rel': 0, 'showinfo': 0, 'autoplay': 1, 'loop': 1 },
                events: { 'onReady': (e) => e.target.mute() }
            });
        };

        PlayerManager.onPlayerReady = (event) => {
            AppState.isPlayerReady = true;
            AppState.audioPlayer.setVolume(DOM.volumeSlider.value);
            PlayerManager.loadTrack(AppState.currentTrackIndex, true);
        };
        
        PlayerManager.onAudioPlayerStateChange = (event) => {
            const isPlaying = event.data === YT.PlayerState.PLAYING;
            PlayerManager.updateUIIsPlaying(isPlaying);
            
            if (AppState.videoPlayer && typeof AppState.videoPlayer.playVideo === 'function') {
                if (isPlaying) AppState.videoPlayer.playVideo();
                else AppState.videoPlayer.pauseVideo();
            }

            if (isPlaying) PlayerManager.startProgressUpdater(); 
            else PlayerManager.stopProgressUpdater();
            
            if (event.data === YT.PlayerState.ENDED) PlayerManager.playNextTrack();
        };

        // Initialize the application
        window.onload = () => {
            ScreenManager.renderSelectionScreen();
            ScreensaverManager.resetScreensaverTimer();
            
            // Event listeners
            ['mousemove', 'keydown', 'click'].forEach(evt => 
                document.addEventListener(evt, ScreensaverManager.resetScreensaverTimer, false)
            );

            DOM.playBtn.addEventListener('click', PlayerManager.playMusic);
            DOM.pauseBtn.addEventListener('click', PlayerManager.pauseMusic);
            DOM.stopBtn.addEventListener('click', PlayerManager.stopMusic);
            DOM.nextBtn.addEventListener('click', PlayerManager.playNextTrack);
            DOM.prevBtn.addEventListener('click', PlayerManager.playPrevTrack);
            DOM.rewindBtn.addEventListener('click', () => PlayerManager.seek(-10));
            DOM.forwardBtn.addEventListener('click', () => PlayerManager.seek(10));
            DOM.backBtn.addEventListener('click', PlayerManager.returnToSelection);
            
            DOM.volumeSlider.addEventListener('input', (e) => {
                if (AppState.audioPlayer && AppState.isPlayerReady) {
                    AppState.audioPlayer.setVolume(e.target.value);
                }
            });
            
            DOM.tracklistBtn.addEventListener('click', TracklistManager.showTracklist);
            DOM.closeTracklistBtn.addEventListener('click', TracklistManager.hideTracklist);
            DOM.soundscapeBtn.addEventListener('click', PlayerManager.toggleSoundscapeMode);
            DOM.exitSoundscapeBtn.addEventListener('click', PlayerManager.toggleSoundscapeMode);
            DOM.exitFullscreenBtn.addEventListener('click', PlayerManager.toggleSoundscapeMode);
            
            DOM.shuffleBtn.addEventListener('click', () => {
                AppState.isShuffle = !AppState.isShuffle;
                DOM.shuffleBtn.classList.toggle('active', AppState.isShuffle);
            });
            
            DOM.repeatBtn.addEventListener('click', () => {
                const modes = ['all', 'one', 'none'];
                AppState.repeatMode = modes[(modes.indexOf(AppState.repeatMode) + 1) % modes.length];
                DOM.repeatBtn.textContent = `Repeat ${AppState.repeatMode.charAt(0).toUpperCase() + AppState.repeatMode.slice(1)}`;
                DOM.repeatBtn.classList.toggle('active', AppState.repeatMode !== 'none');
            });

            DOM.vizBtn.addEventListener('click', () => {
                AppState.visualizerMode = AppState.visualizerMode === 'bars' ? 'off' : 'bars';
                DOM.vizBtn.textContent = `Viz: ${AppState.visualizerMode.charAt(0).toUpperCase() + AppState.visualizerMode.slice(1)}`;
            });
        };
    </script>
</body>
</html>
