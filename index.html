<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS2 Style Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --ps2-blue: #0033cc;
            --ps2-dark-blue: #001a66;
            --ps2-text: #e0e0e0;
            --album-theme-color: var(--ps2-blue);
        }

        body {
            font-family: 'VT323', monospace;
            background-color: #0d0d0d;
            color: var(--ps2-text);
            overflow: hidden;
            background: linear-gradient(-45deg, #001a66, #0d0d0d, #0033cc, #0d0d0d);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Efeitos CRT (TV antiga) */
        .crt-effect::before {
            content: " ";
            display: block;
            position: fixed;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 100;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            animation: flicker 0.15s infinite;
        }
        .crt-effect::after {
            content: " ";
            display: block;
            position: fixed;
            top: 0; left: 0; bottom: 0; right: 0;
            background: rgba(18, 16, 16, 0.1);
            opacity: 0;
            z-index: 100;
            pointer-events: none;
            animation: scanline 10s linear infinite;
        }

        @keyframes flicker {
            0% { opacity: 0.2; } 20% { opacity: 0.8; } 40% { opacity: 0.3; }
            60% { opacity: 1; } 80% { opacity: 0.4; } 100% { opacity: 1; }
        }
        @keyframes scanline {
            0% { transform: translateY(0%); } 100% { transform: translateY(100%); }
        }

        .screen-container {
            width: 100vw; height: 100vh;
            position: absolute; top: 0; left: 0;
            transition: opacity 0.5s ease-in-out, filter 0.5s ease-in-out;
            filter: blur(0);
        }
        .screen-hidden {
            opacity: 0; pointer-events: none; filter: blur(5px);
        }
        
        /* Tela de Seleção de CD */
        #selection-screen { perspective: 1500px; }
        .cd-selection-item {
            transform-style: preserve-3d;
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
        }
        .cd-selection-item:hover { transform: rotateY(-30deg) scale(1.05); }
        .cd-case {
            width: 200px; height: 200px; position: relative;
            transform-style: preserve-3d; transform: rotateY(0deg);
        }
        .cd-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; background-color: #1a1a1a; border: 1px solid #333;
        }
        .cd-front-cover {
            transform: translateZ(10px); background-size: cover; background-position: center;
        }
        .cd-spine {
            width: 20px; height: 200px; left: 90px; background-color: #111;
            transform: rotateY(90deg) translateZ(-110px);
            display: flex; align-items: center; justify-content: center;
        }
        .cd-spine-text {
            writing-mode: vertical-rl; text-orientation: mixed;
            transform: rotate(180deg); white-space: nowrap; font-size: 14px;
        }

        /* Player Screen */
        .cd-2d {
            width: 150px; height: 150px; border-radius: 50%;
            background-size: cover; background-position: center;
            box-shadow: 0 0 20px 5px rgba(255, 255, 255, 0.2);
            transition: transform 1.5s ease-out; /* Animação de parada suave */
        }
        .cd-2d.playing {
            transition: transform 0.2s linear; /* Transição rápida ao girar */
            animation: spin 4s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        #track-name-container { width: 250px; overflow: hidden; position: relative; }
        #track-name {
            display: inline-block; white-space: nowrap; position: absolute;
            left: 50%; transform: translateX(-50%);
        }
        .scrolling { animation: scroll-text 10s linear infinite; }
        @keyframes scroll-text {
            0%   { transform: translateX(100%); } 100% { transform: translateX(-100%); }
        }
        
        #progress-bar-container { display: flex; gap: 2px; cursor: pointer; }
        .progress-block {
            flex-grow: 1; height: 12px; background-color: #333; transition: background-color 0.2s;
        }
        .progress-block.filled { background-color: var(--ps2-text); }
        
        .player-btn {
            background-color: rgba(0,0,0,0.3); border: 1px solid var(--ps2-text);
            padding: 5px; transition: all 0.2s;
        }
        .player-btn:hover { background-color: var(--ps2-text); color: #0d0d0d; }
        .player-btn:active { transform: scale(0.9); }
        .player-btn.active {
            background-color: var(--album-theme-color); border-color: var(--album-theme-color); color: #fff;
        }

        /* Animação de Transição de CD */
        #cd-transition-wrapper {
            position: fixed; z-index: 200;
            transform-style: preserve-3d;
            perspective: 1000px;
            pointer-events: none; /* Impede interação durante a animação */
            opacity: 0;
        }
        #cd-transition-case-front {
            width: 100%; height: 100%;
            background-size: cover;
            position: absolute;
            transform-origin: left;
            transition: transform 0.5s ease-in-out, opacity 0.3s linear;
        }
        #cd-transition-disc {
            width: 90%; height: 90%;
            background-size: cover;
            border-radius: 50%;
            position: absolute;
            top: 5%; left: 5%;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Efeito VHS */
        .vhs-effect { filter: sepia(0.3) contrast(1.1) brightness(0.9) blur(0.2px); }
        .vhs-effect::after {
            content: " "; display: block; position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1) 0px, rgba(0,0,0,0.1) 1px, transparent 1px, transparent 3px);
            z-index: 1; pointer-events: none;
            animation: vhs-noise 0.1s steps(3, end) infinite;
        }
        @keyframes vhs-noise {
            0% { transform: translate(0, 0); } 25% { transform: translate(2px, -3px); }
            50% { transform: translate(-2px, 2px); } 75% { transform: translate(1px, 4px); }
            100% { transform: translate(-1px, -2px); }
        }

        /* Screensaver DVD */
        #dvd-screensaver {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #000; z-index: 300;
        }
        #dvd-logo {
            position: absolute; width: 150px; height: auto; font-size: 5rem;
            font-weight: bold; color: white; text-shadow: 2px 2px 4px #000;
        }
        
        /* Tracklist Modal */
        #tracklist-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            z-index: 250; display: flex; align-items: center; justify-content: center;
        }
        #tracklist-content {
            background-color: #0d0d0d; border: 2px solid var(--ps2-text);
            width: 90%; max-width: 500px; max-height: 80vh;
            display: flex; flex-direction: column;
        }
        #tracklist-header {
            padding: 1rem; border-bottom: 2px solid var(--ps2-text);
            display: flex; justify-content: space-between; align-items: center;
        }
        #tracklist-list { padding: 1rem; overflow-y: auto; }
        .tracklist-item {
            padding: 0.5rem; font-size: 1.5rem; cursor: pointer;
            border-bottom: 1px solid #333;
        }
        .tracklist-item:hover { background-color: var(--album-theme-color); color: #fff; }
        .tracklist-item.playing {
            background-color: var(--album-theme-color); color: #fff; font-weight: bold;
        }
        
        /* Fullscreen Mode melhorado */
        #fullscreen-video-mode {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #fullscreen-content {
            position: relative; z-index: 5;
            display: flex;
            align-items: center;
            gap: 2rem;
            padding: 2rem;
            background-color: rgba(0,0,0,0.5);
            border: 2px solid var(--ps2-text);
        }
        #fullscreen-cover {
            width: 200px;
            height: 200px;
            background-size: cover;
            border: 2px solid var(--ps2-text);
        }
        #fullscreen-track-name {
            font-size: 3rem;
            max-width: 400px;
        }

    </style>
</head>
<body class="bg-black text-white crt-effect">

    <!-- Tela de Seleção de Discos -->
    <div id="selection-screen" class="screen-container flex flex-col items-center justify-center p-8">
        <h1 class="text-6xl mb-12 tracking-widest">Select Disc</h1>
        <div id="cd-selection-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-16">
            <!-- CDs serão inseridos aqui via JS -->
        </div>
        <div id="secret-cd-container" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-16 mt-8">
            <!-- CDs secretos aparecem aqui -->
        </div>
    </div>

    <!-- Tela do Player -->
    <div id="player-screen" class="screen-container screen-hidden flex flex-col items-center justify-between p-4 h-full">
        <div id="video-background-container" class="absolute top-0 left-0 w-full h-full -z-10 opacity-30 overflow-hidden">
             <div id="video-background-player"></div>
             <div id="video-background-overlay" class="absolute top-0 left-0 w-full h-full"></div>
        </div>
        <div class="w-full flex justify-between items-start text-2xl">
            <button id="back-btn" class="player-btn">← Back</button>
            <div id="clock" class="pr-2">12:00:00</div>
        </div>
        <div class="flex flex-col items-center gap-4">
            <div id="player-cd" class="cd-2d"></div>
            <div id="track-number" class="text-2xl">TRACK 01</div>
            <div id="track-name-container" class="h-8 text-3xl text-center"><span id="track-name">Track Name</span></div>
            <div id="visualizer" class="w-80 h-16 flex items-end justify-center gap-1"></div>
        </div>
        <div class="w-full max-w-2xl flex flex-col items-center gap-3">
            <div class="w-full flex justify-between text-2xl">
                <div id="time-display">0:00 / 0:00</div>
            </div>
            <div id="progress-bar-container" class="w-full h-3 rounded-full"></div>
            <div class="flex items-center gap-4 text-3xl mt-2">
                <button id="rewind-btn" class="player-btn">«5s</button>
                <button id="prev-btn" class="player-btn">«</button>
                <button id="play-btn" class="player-btn">▶</button>
                <button id="pause-btn" class="player-btn hidden">❚❚</button>
                <button id="next-btn" class="player-btn">»</button>
                <button id="forward-btn" class="player-btn">5s»</button>
            </div>
             <div class="flex items-center gap-4 text-xl mt-2">
                <button id="shuffle-btn" class="player-btn">Shuffle</button>
                <button id="repeat-btn" class="player-btn">Repeat</button>
                <button id="viz-btn" class="player-btn active">Visualizer</button>
                <button id="soundscape-btn" class="player-btn">Soundscape</button>
                <button id="tracklist-btn" class="player-btn">Tracklist</button>
            </div>
             <div class="flex items-center gap-2 text-xl">
                <span>Volume</span>
                <input id="volume-slider" type="range" min="0" max="100" value="80" class="w-32">
            </div>
        </div>
    </div>

    <!-- Modal da Tracklist -->
    <div id="tracklist-modal" class="screen-hidden">
        <div id="tracklist-content">
            <div id="tracklist-header">
                <h2 id="tracklist-album-title" class="text-3xl">Tracklist</h2>
                <button id="close-tracklist-btn" class="player-btn text-2xl">X</button>
            </div>
            <div id="tracklist-list"></div>
        </div>
    </div>

    <!-- Modo Soundscape -->
    <div id="soundscape-mode" class="screen-container screen-hidden flex flex-col items-center justify-center text-white">
        <div class="relative z-10 flex flex-col items-center justify-center text-center">
            <div id="soundscape-cd" class="cd-2d playing" style="width: 300px; height: 300px;"></div>
            <h2 id="soundscape-track-name" class="text-5xl mt-8">Track Name</h2>
            <p id="soundscape-time" class="text-3xl mt-4">0:00 / 0:00</p>
            <button id="exit-soundscape-btn" class="player-btn mt-8 text-2xl">Exit</button>
        </div>
    </div>

    <!-- Modo Vídeo Fullscreen -->
    <div id="fullscreen-video-mode" class="screen-container screen-hidden">
         <div id="fullscreen-video-player" class="absolute top-0 left-0 w-full h-full z-0"></div>
         <div id="fullscreen-content">
            <div id="fullscreen-cover"></div>
            <h2 id="fullscreen-track-name"></h2>
         </div>
         <button id="exit-fullscreen-btn" class="player-btn absolute bottom-5 z-10 text-2xl">Exit Fullscreen</button>
    </div>
    
    <!-- Protetor de Tela DVD -->
    <div id="dvd-screensaver" class="screen-hidden">
        <div id="dvd-logo">DVD</div>
    </div>

    <!-- Elemento de transição -->
    <div id="cd-transition-wrapper">
        <div id="cd-transition-case-front"></div>
        <div id="cd-transition-disc"></div>
    </div>
    
    <!-- Player do YouTube (invisível) -->
    <div id="youtube-player" class="absolute -top-full -left-full"></div>

    <script>
        const albums = [
            {
                title: "Validation",
                cover: "https://i1.sndcdn.com/artworks-zMJy5oUhjfM05LnK-AzuGwA-t500x500.jpg",
                theme: { primary: '#4CAF50', secondary: '#0033cc' }, // Verde e Azul
                videoTint: 'blue',
                tracks: [
                    { title: "Sucesso FM", audioId: 'tkl_smLRtcE', musicVideoId: 'tqdOIs3K-SA', videoLoop: true },
                    { title: "Rumo a Vitória", audioId: 'gTsZ-vQLq74' },
                    { title: "Goddamn", audioId: 'fGhkeEmMDSU' },
                    { title: "I Walk", audioId: 'pKyoxG2ZDh8', musicVideoId: 'lvABzBQDYGY', videoLoop: true },
                    { title: "Waiting to Fly", audioId: '-1WfKz06Hgc', musicVideoId: 'hX2NJxJP6Mc', videoLoop: true },
                    { title: "Sonhar", audioId: 'llJZ4H4zQ2k', musicVideoId: 'WCtvzfzKStU', videoStart: 39, videoLoop: true },
                    { title: "I'm in Love", audioId: 'TQ2OtyCtOMc' },
                    { title: "For my Family", audioId: 'u3M_KURTWKY', musicVideoId: 'krU-M8WusuY', videoLoop: true },
                    { title: "Going Home", audioId: 'm8SzrWpCjKU' },
                    { title: "The Lord and Me", audioId: 'rfIV2uGZ2kM' },
                    { title: "Anjos da Guarda", audioId: 'ozu12D-DdJk', musicVideoId: 'gI_2-LacLiI', videoLoop: true },
                    { title: "We Gold", audioId: 'HjA6fwTInT0' },
                ]
            },
            {
                title: "Bittersweet Memories",
                cover: "https://i.scdn.co/image/ab67616d0000b2732e8e4cfa666ea534d070c041",
                theme: { primary: '#f59e0b', secondary: '#fbbf24' }, // Laranja Dourado e Amarelo
                tracks: [
                    { title: "Saúde", audioId: 'xXeDMfisrU8' }, { title: "Filho Pródigo", audioId: 'rsxeE1WkHqw' },
                    { title: "Let It Pour", audioId: 'KzUUemEW_iI' }, { title: "The Story", audioId: 'qkaxqSGI_OE' },
                    { title: "Back Home", audioId: 'fnRyVCxqLqk' }, { title: "Melhor Não", audioId: 'RMeJND0yzeM' },
                    { title: "Old School", audioId: 'yApMEdYtkGM' }, { title: "Dirty Dancing", audioId: 'ZBe3GmoFJys' },
                    { title: "Prefiro Morrer", audioId: 'g0_DLkqjylU' }, { title: "Quase Perfeito", audioId: 'vLQR5UCq5J0' },
                    { title: "Máquina do Tempo", audioId: 'Z7LsJA7NJF0', musicVideoId: 'Z7LsJA7NJF0', videoLoop: true, vhs: true },
                    { title: "Flores de Outro Carnaval", audioId: 'tR-m63k2nNM' },
                ]
            },
            {
                title: "13 Lentes de um Final Feliz",
                cover: "https://cdn-images.dzcdn.net/images/cover/a01cc5f5bbb09711637d4927e9ab83cd/500x500.jpg",
                theme: { primary: '#e5e7eb', secondary: '#9ca3af' }, // Branco e Cinza
                tracks: [
                    { title: "Au revoir", audioId: 'asI5cHpQPAA' }, 
                    { title: "Carruagem", audioId: 'wRlhPzhgqu0' },
                    { title: "Agradeço", audioId: 'GPemhYrDATw' }, 
                    { title: "Corrida", audioId: 'mNlhepSXi4g' },
                    { title: "Joias da Família", audioId: 'WlylgE8fSLs' },
                    { title: "Nunca Paro", audioId: 'TSLRScqwemI', musicVideoId: 'P9NqaluDZuk', videoLoop: true },
                    { title: "Memórias", audioId: 'GC-BHmtlhFQ' }, 
                    { title: "Lost in Translation", audioId: '6ep0itQcsUM' },
                    { title: "Primavera", audioId: 'nKJyKsFgDJY' }, 
                    { title: "Let me see the sun", audioId: 'MVrIi0zI6gc' },
                    { title: "Adeus", audioId: 'vWsdkDa3vOw' }, 
                    { title: "Deixa Doer", audioId: 'cgW6sqr8X0k' },
                    { title: "Não me faça falar", audioId: 'lUu0sFJfN80', musicVideoId: 'Ryz5LuaFznM', videoLoop: true },
                ]
            },
            {
                title: "Óptica",
                cover: "https://images.genius.com/a1c5e0cebf8fdb9629ff8205d02af9ff.1000x1000x1.png",
                theme: { primary: '#a0c4ff', secondary: '#ffffff' }, // Azul Bebê e Branco
                tracks: [
                    { title: "Absorver", audioId: 'DWV5g3m3118' }, 
                    { title: "Reflexo", audioId: 'YbQj7ByNkNM' },
                    { title: "Sombra", audioId: 'ENmHHlGVAtE', musicVideoId: '1EYOFvZmnJE', videoLoop: true },
                    { title: "Transparência", audioId: 'd-mQtP2JHJY' },
                ]
            },
            {
                title: "Bons Tempos",
                cover: "https://akamai.sscdn.co/uploadfile/letras/albuns/3/0/9/c/2338071724245865.jpg",
                theme: { primary: '#a78bfa', secondary: '#fefce8' }, // Roxo e Cor da Lua (Marfim)
                tracks: [
                    { title: "Quando a noite vem", audioId: 'XUYNTXXhmbc' },
                    { title: "Oxford Shoes", audioId: 'wwVejlwrKTA' },
                    { title: "Twist", audioId: 'R3BWRueflA4', musicVideoId: 'hcL33v1N8uQ', videoLoop: true },
                    { title: "American Dream", audioId: '61o4MC3kEsM' },
                    { title: "A Cidade sem você", audioId: 'MUqryi1MIrs' },
                    { title: "Um certo alguem", audioId: 'amC0UxaMz9Y' },
                    { title: "Playback", audioId: 'slgXDu2Ck2A' },
                    { title: "Amiga fiel", audioId: 'wVmcDQ_yX5g' },
                    { title: "Televisão", audioId: 'yqRAcdaqLNI' },
                    { title: "Raise my hands", audioId: 'y1v-bI4_k2I' },
                ]
            }
        ];
        
        const secretAlbums = [
            {
                title: "O Retorno do Filho",
                cover: "https://placehold.co/500x500/1a1a1a/ffffff?text=O+Retorno",
                theme: { primary: '#b91c1c', secondary: '#fef2f2' },
                tracks: [{ title: "A Jornada de Volta", audioId: 'dQw4w9WgXcQ' }]
            },
            {
                title: "A Vitória Final",
                cover: "https://placehold.co/500x500/a16207/ffffff?text=A+Vitória",
                theme: { primary: '#a16207', secondary: '#fefce8' },
                tracks: [{ title: "Coroação", audioId: 'dQw4w9WgXcQ' }]
            }
        ];

        // Elementos da DOM
        const selectionScreen = document.getElementById('selection-screen');
        const playerScreen = document.getElementById('player-screen');
        const cdSelectionGrid = document.getElementById('cd-selection-grid');
        const backBtn = document.getElementById('back-btn');
        const playerCd = document.getElementById('player-cd');
        const trackNumberEl = document.getElementById('track-number');
        const trackNameEl = document.getElementById('track-name');
        const trackNameContainer = document.getElementById('track-name-container');
        const timeDisplayEl = document.getElementById('time-display');
        const progressBar = document.getElementById('progress-bar-container');
        const playBtn = document.getElementById('play-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const stopBtn = document.getElementById('stop-btn');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const rewindBtn = document.getElementById('rewind-btn');
        const forwardBtn = document.getElementById('forward-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const vizBtn = document.getElementById('viz-btn');
        const soundscapeBtn = document.getElementById('soundscape-btn');
        const tracklistBtn = document.getElementById('tracklist-btn');
        const volumeSlider = document.getElementById('volume-slider');
        const clockEl = document.getElementById('clock');
        const visualizerEl = document.getElementById('visualizer');
        
        // Modal
        const tracklistModal = document.getElementById('tracklist-modal');
        const tracklistAlbumTitle = document.getElementById('tracklist-album-title');
        const tracklistList = document.getElementById('tracklist-list');
        const closeTracklistBtn = document.getElementById('close-tracklist-btn');
        
        // Modos
        const soundscapeMode = document.getElementById('soundscape-mode');
        const exitSoundscapeBtn = document.getElementById('exit-soundscape-btn');
        const fullscreenVideoMode = document.getElementById('fullscreen-video-mode');
        const fullscreenContent = document.getElementById('fullscreen-content');
        const fullscreenCover = document.getElementById('fullscreen-cover');
        const fullscreenTrackName = document.getElementById('fullscreen-track-name');
        const exitFullscreenBtn = document.getElementById('exit-fullscreen-btn');
        const soundscapeCd = document.getElementById('soundscape-cd');
        const soundscapeTrackName = document.getElementById('soundscape-track-name');
        const soundscapeTime = document.getElementById('soundscape-time');

        // Screensaver
        const dvdScreensaver = document.getElementById('dvd-screensaver');
        const dvdLogo = document.getElementById('dvd-logo');
        
        // Vídeo
        const videoBgContainer = document.getElementById('video-background-container');
        const videoBgOverlay = document.getElementById('video-background-overlay');

        // Estado do Player
        let player, videoBgPlayer, fullscreenVideoPlayer;
        let currentAlbumIndex = 0, currentTrackIndex = 0;
        let playlist = [], isPlaying = false, isShuffle = false;
        let repeatMode = 'none', progressInterval, inactivityTimer;
        let keySequence = '';
        const secretPhrase = 'o filho prodigo sempre vence.';
        let secretsUnlocked = false;
        
        // Inicialização do YouTube IFrame API
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-player', {
                height: '0', width: '0',
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
            videoBgPlayer = new YT.Player('video-background-player', {
                height: '100%', width: '100%',
                playerVars: { 'autoplay': 1, 'controls': 0, 'showinfo': 0, 'rel': 0, 'mute': 1, 'playsinline': 1 },
                events: { 'onReady': (e) => e.target.mute(), 'onStateChange': onVideoStateChange }
            });
            fullscreenVideoPlayer = new YT.Player('fullscreen-video-player', {
                height: '100%', width: '100%',
                playerVars: { 'autoplay': 0, 'controls': 0, 'showinfo': 0, 'rel': 0, 'mute': 1, 'playsinline': 1 },
                 events: { 'onReady': (e) => e.target.mute(), 'onStateChange': onVideoStateChange }
            });
        }

        function onPlayerReady(event) {
            event.target.setVolume(volumeSlider.value);
        }

        function onPlayerStateChange(event) {
            const state = event.data;
            if (state === YT.PlayerState.PLAYING) {
                isPlaying = true;
                clearTimeout(inactivityTimer);
                hideDvdScreensaver();
                startProgressInterval();
                updatePlayPauseButtons();
                playerCd.classList.add('playing');
                if(videoBgPlayer?.playVideo) videoBgPlayer.playVideo();
                if(fullscreenVideoPlayer?.isMuted() && fullscreenVideoPlayer?.playVideo) fullscreenVideoPlayer.playVideo();
            } else {
                isPlaying = false;
                resetInactivityTimer();
                stopProgressInterval();
                updatePlayPauseButtons();
                playerCd.classList.remove('playing');
                if (state === YT.PlayerState.PAUSED) {
                    if(videoBgPlayer?.pauseVideo) videoBgPlayer.pauseVideo();
                    if(fullscreenVideoPlayer?.pauseVideo) fullscreenVideoPlayer.pauseVideo();
                }
            }
            if (state === YT.PlayerState.ENDED) { handleTrackEnd(); }
        }

        function onVideoStateChange(event) {
            const track = albums[currentAlbumIndex].tracks[playlist[currentTrackIndex]];
            if (event.data === YT.PlayerState.ENDED && track.videoLoop) {
                event.target.seekTo(track.videoStart || 0);
                event.target.playVideo();
            }
        }
        
        function handleTrackEnd() {
            if (repeatMode === 'one') { playTrack(currentTrackIndex); } else { playNext(); }
        }

        function loadAlbum(albumIndex, isSecret = false) {
            const source = isSecret ? secretAlbums : albums;
            currentAlbumIndex = albumIndex;
            const album = source[albumIndex];
            playlist = Array.from(Array(album.tracks.length).keys());
            if(isShuffle) { shufflePlaylist(); }
            loadTrack(0, isSecret);
            updatePlayerUIForAlbum(album);
            showScreen(playerScreen);
        }

        function loadTrack(playlistIndex, isSecret = false) {
            if (playlistIndex < 0 || playlistIndex >= playlist.length) {
                 if (repeatMode === 'all') { currentTrackIndex = 0; } else { stopPlayback(); return; }
            } else { currentTrackIndex = playlistIndex; }

            const source = isSecret ? secretAlbums : albums;
            const trackIndexInAlbum = playlist[currentTrackIndex];
            const track = source[currentAlbumIndex].tracks[trackIndexInAlbum];
            
            player.loadVideoById({ videoId: track.audioId, startSeconds: track.startSeconds || 0 });
            updateTrackInfo(track, trackIndexInAlbum);
            
            videoBgContainer.classList.toggle('vhs-effect', !!track.vhs);
            fullscreenVideoMode.classList.toggle('vhs-effect', !!track.vhs);

            if (track.musicVideoId && videoBgPlayer?.loadVideoById) {
                videoBgPlayer.loadVideoById({ videoId: track.musicVideoId, startSeconds: track.videoStart || 0 });
                videoBgContainer.style.opacity = '0.3';
                soundscapeBtn.textContent = "Fullscreen";
            } else {
                if(videoBgPlayer?.stopVideo) videoBgPlayer.stopVideo();
                videoBgContainer.style.opacity = '0';
                soundscapeBtn.textContent = "Soundscape";
            }
        }
        
        function playTrack(playlistIndex) { loadTrack(playlistIndex); }
        function playNext() {
            let nextIndex = currentTrackIndex + 1;
            if (nextIndex >= playlist.length) {
                if (repeatMode === 'all') { nextIndex = 0; } else { stopPlayback(); return; }
            }
            playTrack(nextIndex);
        }
        function playPrev() {
            let prevIndex = currentTrackIndex - 1;
            if (prevIndex < 0) { prevIndex = playlist.length - 1; }
            playTrack(prevIndex);
        }
        function stopPlayback() {
            if(player?.stopVideo) player.stopVideo();
            if(videoBgPlayer?.stopVideo) videoBgPlayer.stopVideo();
            if(fullscreenVideoPlayer?.stopVideo) fullscreenVideoPlayer.stopVideo();
            stopProgressInterval(); resetProgressBar();
            isPlaying = false; updatePlayPauseButtons(); playerCd.classList.remove('playing');
            resetInactivityTimer();
        }
        function seekRelative(seconds) {
            const currentTime = player.getCurrentTime();
            const newTime = currentTime + seconds;
            player.seekTo(newTime, true);
            if(videoBgPlayer?.seekTo) videoBgPlayer.seekTo(newTime, true);
            if(fullscreenVideoPlayer?.seekTo) fullscreenVideoPlayer.seekTo(newTime, true);
        }
        function toggleShuffle() {
            isShuffle = !isShuffle;
            shuffleBtn.classList.toggle('active', isShuffle);
            const currentTrackRealIndex = playlist[currentTrackIndex];
            if (isShuffle) { shufflePlaylist(); } 
            else { playlist = Array.from(Array(albums[currentAlbumIndex].tracks.length).keys()); }
            currentTrackIndex = playlist.findIndex(i => i === currentTrackRealIndex);
        }
        function shufflePlaylist() {
            for (let i = playlist.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [playlist[i], playlist[j]] = [playlist[j], playlist[i]];
            }
        }
        function toggleRepeat() {
            if(repeatMode === 'none') { repeatMode = 'all'; repeatBtn.textContent = 'Repeat All'; repeatBtn.classList.add('active'); } 
            else if (repeatMode === 'all') { repeatMode = 'one'; repeatBtn.textContent = 'Repeat One'; } 
            else { repeatMode = 'none'; repeatBtn.textContent = 'Repeat'; repeatBtn.classList.remove('active'); }
        }

        // Funções de UI
        function createCdElement(album, index, isSecret = false) {
            const item = document.createElement('div');
            item.className = 'cd-selection-item';
            item.innerHTML = `<div class="cd-case"><div class="cd-face cd-front-cover" style="background-image: url('${album.cover}')"></div><div class="cd-face cd-spine"><span class="cd-spine-text">${album.title}</span></div></div>`;
            item.addEventListener('mouseenter', () => document.documentElement.style.setProperty('--album-theme-color', album.theme.primary));
            item.addEventListener('click', () => handleCDSelection(item, index, isSecret));
            return item;
        }

        function initializeCDSelection() {
            cdSelectionGrid.innerHTML = '';
            albums.forEach((album, index) => {
                cdSelectionGrid.appendChild(createCdElement(album, index, false));
            });
        }
        
        function handleCDSelection(element, albumIndex, isSecret = false) {
            const source = isSecret ? secretAlbums : albums;
            const album = source[albumIndex];
            const startRect = element.getBoundingClientRect();
            const transitionWrapper = document.getElementById('cd-transition-wrapper');
            const caseFront = document.getElementById('cd-transition-case-front');
            const disc = document.getElementById('cd-transition-disc');

            // Reset styles
            transitionWrapper.style.transition = 'opacity 0.5s ease-in-out';
            caseFront.style.transition = 'transform 0.5s ease-in-out, opacity 0.3s linear';
            disc.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
            
            Object.assign(transitionWrapper.style, {
                left: `${startRect.left}px`, top: `${startRect.top}px`,
                width: `${startRect.width}px`, height: `${startRect.height}px`,
                opacity: '1',
            });
            caseFront.style.backgroundImage = `url('${album.cover}')`;
            caseFront.style.transform = 'rotateY(0deg)';
            caseFront.style.opacity = '1';
            disc.style.backgroundImage = `url('${album.cover}')`;
            disc.style.transform = 'translateX(0%)';
            disc.style.left = '5%';
            disc.style.top = '5%';
            disc.style.width = '90%';
            disc.style.height = '90%';
            
            selectionScreen.classList.add('screen-hidden');

            setTimeout(() => { // Abrir a caixa
                caseFront.style.transform = 'rotateY(-120deg)';
            }, 100);
            
            setTimeout(() => { // Disco desliza para fora
                disc.style.transform = 'translateX(80%)';
            }, 400);

            setTimeout(() => { // Disco voa para o player
                const targetRect = playerCd.getBoundingClientRect();
                caseFront.style.opacity = '0';
                Object.assign(disc.style, {
                    left: `${targetRect.left - startRect.left}px`, 
                    top: `${targetRect.top - startRect.top}px`,
                    width: `${targetRect.width}px`, 
                    height: `${targetRect.height}px`,
                    transform: 'translateX(0) rotate(720deg)',
                });
            }, 900);

            setTimeout(() => { // Animação termina
                loadAlbum(albumIndex, isSecret);
                transitionWrapper.style.opacity = '0';
            }, 1700); // 900ms (start) + 800ms (duration)
        }

        function showScreen(screen) {
            document.querySelectorAll('.screen-container').forEach(s => s.classList.add('screen-hidden'));
            screen.classList.remove('screen-hidden');
        }
        
        function updatePlayerUIForAlbum(album) {
            document.documentElement.style.setProperty('--album-theme-color', album.theme.primary);
            playerCd.style.backgroundImage = `url('${album.cover}')`;
            soundscapeCd.style.backgroundImage = `url('${album.cover}')`;
            soundscapeMode.style.backgroundImage = `url('${album.cover}')`;
            videoBgOverlay.classList.toggle('blue-tint', album.videoTint === 'blue');
            if (album.videoTint !== 'blue') {
                videoBgOverlay.style.backgroundColor = `${album.theme.secondary}66`;
            } else {
                videoBgOverlay.style.backgroundColor = '';
            }
        }

        function updateTrackInfo(track, trackIndexInAlbum) {
            trackNumberEl.textContent = `TRACK ${String(trackIndexInAlbum + 1).padStart(2, '0')}`;
            trackNameEl.textContent = track.title;
            soundscapeTrackName.textContent = track.title;
            setTimeout(() => trackNameEl.classList.toggle('scrolling', trackNameEl.scrollWidth > trackNameContainer.offsetWidth), 100);
        }

        function updatePlayPauseButtons() {
            playBtn.classList.toggle('hidden', isPlaying);
            pauseBtn.classList.toggle('hidden', !isPlaying);
        }
        
        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${String(sec).padStart(2, '0')}`;
        }
        
        function startProgressInterval() {
            stopProgressInterval();
            progressInterval = setInterval(() => {
                const currentTime = player.getCurrentTime() || 0;
                const duration = player.getDuration() || 0;
                const timeText = `${formatTime(currentTime)} / ${formatTime(duration)}`;
                timeDisplayEl.textContent = timeText;
                soundscapeTime.textContent = timeText;
                updateProgressBar(duration > 0 ? (currentTime / duration) : 0);
            }, 500);
        }
        
        function stopProgressInterval() { clearInterval(progressInterval); }
        function resetProgressBar() { updateProgressBar(0); timeDisplayEl.textContent = `0:00 / 0:00`; }

        function createProgressBar() {
            progressBar.innerHTML = '';
            for (let i = 0; i < 40; i++) { progressBar.appendChild(document.createElement('div')).className = 'progress-block'; }
        }

        function updateProgressBar(progress) {
            const blocks = progressBar.children;
            const filledBlocks = Math.floor(progress * blocks.length);
            for (let i = 0; i < blocks.length; i++) { blocks[i].classList.toggle('filled', i < filledBlocks); }
        }
        
        function updateClock() { clockEl.textContent = new Date().toLocaleTimeString('pt-BR'); }
        
        function createVisualizerBars() {
            visualizerEl.innerHTML = '';
            for (let i = 0; i < 32; i++) {
                const bar = document.createElement('div');
                Object.assign(bar, { className: 'bg-gray-500 w-2', style: 'height: 2px; transition: height 0.1s;' });
                visualizerEl.appendChild(bar);
            }
        }
        
        function animateVisualizer() {
            if (isPlaying && !visualizerEl.classList.contains('hidden')) {
                const bars = visualizerEl.children;
                for (let i = 0; i < bars.length; i++) { bars[i].style.height = `${Math.random() * 100}%`; }
            }
            requestAnimationFrame(animateVisualizer);
        }

        function showTracklist() {
            const album = albums[currentAlbumIndex];
            tracklistAlbumTitle.textContent = album.title;
            tracklistList.innerHTML = '';
            album.tracks.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = 'tracklist-item';
                item.textContent = `${String(index + 1).padStart(2, '0')}. ${track.title}`;
                if (playlist[currentTrackIndex] === index) item.classList.add('playing');
                item.addEventListener('click', () => {
                    const playlistIndex = playlist.findIndex(i => i === index);
                    playTrack(playlistIndex);
                    hideTracklist();
                });
                tracklistList.appendChild(item);
            });
            tracklistModal.classList.remove('screen-hidden');
        }
        function hideTracklist() { tracklistModal.classList.add('screen-hidden'); }

        function toggleSoundscape() {
             const track = albums[currentAlbumIndex].tracks[playlist[currentTrackIndex]];
             if (track.musicVideoId) {
                if (fullscreenVideoPlayer?.loadVideoById) {
                    fullscreenCover.style.backgroundImage = `url('${albums[currentAlbumIndex].cover}')`;
                    fullscreenTrackName.textContent = track.title;
                    fullscreenVideoPlayer.loadVideoById({ videoId: track.musicVideoId, startSeconds: player.getCurrentTime() });
                    fullscreenVideoPlayer.mute();
                }
                showScreen(fullscreenVideoMode);
             } else { showScreen(soundscapeMode); }
        }
        function exitSoundscape() { showScreen(playerScreen); }
        function exitFullscreen() {
            if(fullscreenVideoPlayer?.stopVideo) fullscreenVideoPlayer.stopVideo();
            showScreen(playerScreen);
        }
        
        // Screensaver
        function hideDvdScreensaver() {
            if (dvdScreensaver) {
                dvdScreensaver.classList.add('screen-hidden');
            }
            cancelAnimationFrame(dvdAnimation);
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            hideDvdScreensaver();
            if (!isPlaying) {
                inactivityTimer = setTimeout(showDvdScreensaver, 120000);
            }
        }

        let dvd = { x: 50, y: 50, vx: 2, vy: 2, logo: dvdLogo };
        let dvdAnimation;
        function showDvdScreensaver() {
            dvdScreensaver.classList.remove('screen-hidden');
            dvdAnimation = requestAnimationFrame(animateDvdLogo);
        }
        function animateDvdLogo() {
            const screenW = window.innerWidth, screenH = window.innerHeight;
            const logoW = dvd.logo.offsetWidth, logoH = dvd.logo.offsetHeight;
            dvd.x += dvd.vx; dvd.y += dvd.vy;
            if (dvd.x + logoW >= screenW || dvd.x <= 0) { dvd.vx *= -1; dvd.logo.style.color = `hsl(${Math.random() * 360}, 100%, 75%)`; }
            if (dvd.y + logoH >= screenH || dvd.y <= 0) { dvd.vy *= -1; dvd.logo.style.color = `hsl(${Math.random() * 360}, 100%, 75%)`; }
            dvd.logo.style.left = `${dvd.x}px`; dvd.logo.style.top = `${dvd.y}px`;
            dvdAnimation = requestAnimationFrame(animateDvdLogo);
        }

        window.onload = () => {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.getElementsByTagName('script')[0].parentNode.insertBefore(tag, document.getElementsByTagName('script')[0]);
            
            initializeCDSelection(); 
            createProgressBar(); 
            createVisualizerBars();
            setInterval(updateClock, 1000); 
            updateClock(); 
            requestAnimationFrame(animateVisualizer);
            
            resetInactivityTimer();
            ['mousemove', 'keypress', 'click'].forEach(evt => document.addEventListener(evt, resetInactivityTimer));

            window.addEventListener('keydown', (e) => {
                if (selectionScreen.classList.contains('screen-hidden')) return;
                keySequence += e.key.toLowerCase();
                if (keySequence.length > secretPhrase.length) {
                    keySequence = keySequence.substring(1);
                }
                if (keySequence.includes(secretPhrase) && !secretsUnlocked) {
                    secretsUnlocked = true;
                    const container = document.getElementById('secret-cd-container');
                    secretAlbums.forEach((album, index) => {
                        container.appendChild(createCdElement(album, index, true));
                    });
                    container.classList.remove('hidden');
                }
            });

            if(volumeSlider) volumeSlider.addEventListener('input', (e) => {
                if(player?.setVolume) player.setVolume(e.target.value);
            });
            if(backBtn) backBtn.addEventListener('click', () => {
                stopPlayback(); showScreen(selectionScreen);
                document.documentElement.style.setProperty('--album-theme-color', 'var(--ps2-blue)');
            });
            if(playBtn) playBtn.addEventListener('click', () => player.playVideo());
            if(pauseBtn) pauseBtn.addEventListener('click', () => player.pauseVideo());
            if(stopBtn) stopBtn.addEventListener('click', stopPlayback);
            if(nextBtn) nextBtn.addEventListener('click', playNext);
            if(prevBtn) prevBtn.addEventListener('click', playPrev);
            if(rewindBtn) rewindBtn.addEventListener('click', () => seekRelative(-5));
            if(forwardBtn) forwardBtn.addEventListener('click', () => seekRelative(5));
            if(shuffleBtn) shuffleBtn.addEventListener('click', toggleShuffle);
            if(repeatBtn) repeatBtn.addEventListener('click', toggleRepeat);
            if(vizBtn) vizBtn.addEventListener('click', () => { visualizerEl.classList.toggle('hidden'); vizBtn.classList.toggle('active'); });
            if(soundscapeBtn) soundscapeBtn.addEventListener('click', toggleSoundscape);
            if(exitSoundscapeBtn) exitSoundscapeBtn.addEventListener('click', exitSoundscape);
            if(exitFullscreenBtn) exitFullscreenBtn.addEventListener('click', exitFullscreen);
            if(tracklistBtn) tracklistBtn.addEventListener('click', showTracklist);
            if(closeTracklistBtn) closeTracklistBtn.addEventListener('click', hideTracklist);

            if(progressBar) progressBar.addEventListener('click', (e) => {
                const rect = progressBar.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const barWidth = progressBar.offsetWidth;
                const progress = clickX / barWidth;
                const duration = player.getDuration();
                
                if (duration > 0) {
                    const newTime = duration * progress;
                    player.seekTo(newTime, true);
                    if(videoBgPlayer?.seekTo) videoBgPlayer.seekTo(newTime, true);
                }
            });
        };
    </script>
</body>
</html>
